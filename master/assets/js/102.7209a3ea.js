(window.webpackJsonp=window.webpackJsonp||[]).push([[102],{917:function(e,t,c){"use strict";c.r(t);var l=c(1),o=Object(l.a)({},(function(){var e=this,t=e.$createElement,c=e._self._c||t;return c("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[c("h1",{attrs:{id:"anatomy-of-an-sdk-application"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#anatomy-of-an-sdk-application"}},[e._v("#")]),e._v(" Anatomy of an SDK Application")]),e._v(" "),c("p",{attrs:{synopsis:""}},[e._v("This document describes the core parts of a Cosmos SDK application. Throughout the document, a placeholder application named "),c("code",[e._v("app")]),e._v(" will be used.")]),e._v(" "),c("h2",{attrs:{id:"node-client"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#node-client"}},[e._v("#")]),e._v(" Node Client")]),e._v(" "),c("p",[e._v("The Daemon, or "),c("RouterLink",{attrs:{to:"/core/node.html"}},[e._v("Full-Node Client")]),e._v(", is the core process of an SDK-based blockchain. Participants in the network run this process to initialize their state-machine, connect with other full-nodes and update their state-machine as new blocks come in.")],1),e._v(" "),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"",base64:"ICAgICAgICAgICAgICAgIF4gICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKyAgXgogICAgICAgICAgICAgICAgfCAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8ICB8CiAgICAgICAgICAgICAgICB8ICB8ICBTdGF0ZS1tYWNoaW5lID0gQXBwbGljYXRpb24gIHwgIHwKICAgICAgICAgICAgICAgIHwgIHwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCAgfCAgIEJ1aWx0IHdpdGggQ29zbW9zIFNESwogICAgICAgICAgICAgICAgfCAgfCAgICAgICAgICAgIF4gICAgICArICAgICAgICAgICB8ICB8CiAgICAgICAgICAgICAgICB8ICArLS0tLS0tLS0tLS0gfCBBQkNJIHwgLS0tLS0tLS0tLSsgIHYKICAgICAgICAgICAgICAgIHwgIHwgICAgICAgICAgICArICAgICAgdiAgICAgICAgICAgfCAgXgogICAgICAgICAgICAgICAgfCAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8ICB8CkJsb2NrY2hhaW4gTm9kZSB8ICB8ICAgICAgICAgICBDb25zZW5zdXMgICAgICAgICAgIHwgIHwKICAgICAgICAgICAgICAgIHwgIHwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCAgfAogICAgICAgICAgICAgICAgfCAgKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rICB8ICAgVGVuZGVybWludCBDb3JlCiAgICAgICAgICAgICAgICB8ICB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgIHwKICAgICAgICAgICAgICAgIHwgIHwgICAgICAgICAgIE5ldHdvcmtpbmcgICAgICAgICAgfCAgfAogICAgICAgICAgICAgICAgfCAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8ICB8CiAgICAgICAgICAgICAgICB2ICArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsgIHYK"}}),e._v(" "),c("p",[e._v("The blockchain full-node presents itself as a binary, generally suffixed by "),c("code",[e._v("-d")]),e._v(' for "daemon" (e.g. '),c("code",[e._v("appd")]),e._v(" for "),c("code",[e._v("app")]),e._v(" or "),c("code",[e._v("gaiad")]),e._v(" for "),c("code",[e._v("gaia")]),e._v("). This binary is built by running a simple "),c("RouterLink",{attrs:{to:"/core/node.html#main-function"}},[c("code",[e._v("main.go")])]),e._v(" function placed in "),c("code",[e._v("./cmd/appd/")]),e._v(". This operation usually happens through the "),c("a",{attrs:{href:"#dependencies-and-makefile"}},[e._v("Makefile")]),e._v(".")],1),e._v(" "),c("p",[e._v("Once the main binary is built, the node can be started by running the "),c("RouterLink",{attrs:{to:"/core/node.html#start-command"}},[c("code",[e._v("start")]),e._v(" command")]),e._v(". This command function primarily does three things:")],1),e._v(" "),c("ol",[c("li",[e._v("Create an instance of the state-machine defined in "),c("a",{attrs:{href:"#core-application-file"}},[c("code",[e._v("app.go")])]),e._v(".")]),e._v(" "),c("li",[e._v("Initialize the state-machine with the latest known state, extracted from the "),c("code",[e._v("db")]),e._v(" stored in the "),c("code",[e._v("~/.appd/data")]),e._v(" folder. At this point, the state-machine is at height "),c("code",[e._v("appBlockHeight")]),e._v(".")]),e._v(" "),c("li",[e._v("Create and start a new Tendermint instance. Among other things, the node will perform a handshake with its peers. It will get the latest "),c("code",[e._v("blockHeight")]),e._v(" from them, and replay blocks to sync to this height if it is greater than the local "),c("code",[e._v("appBlockHeight")]),e._v(". If "),c("code",[e._v("appBlockHeight")]),e._v(" is "),c("code",[e._v("0")]),e._v(", the node is starting from genesis and Tendermint sends an "),c("code",[e._v("InitChain")]),e._v(" message via the ABCI to the "),c("code",[e._v("app")]),e._v(", which triggers the "),c("a",{attrs:{href:"#initchainer"}},[c("code",[e._v("InitChainer")])]),e._v(".")])]),e._v(" "),c("h2",{attrs:{id:"core-application-file"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#core-application-file"}},[e._v("#")]),e._v(" Core Application File")]),e._v(" "),c("p",[e._v("In general, the core of the state-machine is defined in a file called "),c("code",[e._v("app.go")]),e._v(". It mainly contains the "),c("strong",[e._v("type definition of the application")]),e._v(" and functions to "),c("strong",[e._v("create and initialize it")]),e._v(".")]),e._v(" "),c("h3",{attrs:{id:"type-definition-of-the-application"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#type-definition-of-the-application"}},[e._v("#")]),e._v(" Type Definition of the Application")]),e._v(" "),c("p",[e._v("The first thing defined in "),c("code",[e._v("app.go")]),e._v(" is the "),c("code",[e._v("type")]),e._v(" of the application. It is generally comprised of the following parts:")]),e._v(" "),c("ul",[c("li",[c("strong",[e._v("A reference to "),c("RouterLink",{attrs:{to:"/core/baseapp.html"}},[c("code",[e._v("baseapp")])]),e._v(".")],1),e._v(" The custom application defined in "),c("code",[e._v("app.go")]),e._v(" is an extension of "),c("code",[e._v("baseapp")]),e._v(". When a transaction is relayed by Tendermint to the application, "),c("code",[e._v("app")]),e._v(" uses "),c("code",[e._v("baseapp")]),e._v("'s methods to route them to the appropriate module. "),c("code",[e._v("baseapp")]),e._v(" implements most of the core logic for the application, including all the "),c("a",{attrs:{href:"https://tendermint.com/docs/spec/abci/abci.html#overview",target:"_blank",rel:"noopener noreferrer"}},[e._v("ABCI methods"),c("OutboundLink")],1),e._v(" and the "),c("RouterLink",{attrs:{to:"/core/baseapp.html#routing"}},[e._v("routing logic")]),e._v(".")],1),e._v(" "),c("li",[c("strong",[e._v("A list of store keys")]),e._v(". The "),c("RouterLink",{attrs:{to:"/core/store.html"}},[e._v("store")]),e._v(", which contains the entire state, is implemented as a "),c("RouterLink",{attrs:{to:"/core/store.html#multistore"}},[c("code",[e._v("multistore")])]),e._v(" (i.e. a store of stores) in the Cosmos SDK. Each module uses one or multiple stores in the multistore to persist their part of the state. These stores can be accessed with specific keys that are declared in the "),c("code",[e._v("app")]),e._v(" type. These keys, along with the "),c("code",[e._v("keepers")]),e._v(", are at the heart of the "),c("RouterLink",{attrs:{to:"/core/ocap.html"}},[e._v("object-capabilities model")]),e._v(" of the Cosmos SDK.")],1),e._v(" "),c("li",[c("strong",[e._v("A list of module's "),c("code",[e._v("keeper")]),e._v("s.")]),e._v(" Each module defines an abstraction called "),c("RouterLink",{attrs:{to:"/building-modules/keeper.html"}},[c("code",[e._v("keeper")])]),e._v(", which handles reads and writes for this module's store(s). The "),c("code",[e._v("keeper")]),e._v("'s methods of one module can be called from other modules (if authorized), which is why they are declared in the application's type and exported as interfaces to other modules so that the latter can only access the authorized functions.")],1),e._v(" "),c("li",[c("strong",[e._v("A reference to an "),c("RouterLink",{attrs:{to:"/core/encoding.html"}},[c("code",[e._v("appCodec")])]),e._v(".")],1),e._v(" The application's "),c("code",[e._v("appCodec")]),e._v(" is used to serialize and deserialize data structures in order to store them, as stores can only persist "),c("code",[e._v("[]bytes")]),e._v(". The default codec is "),c("RouterLink",{attrs:{to:"/core/encoding.html"}},[e._v("Protocol Buffers")]),e._v(".")],1),e._v(" "),c("li",[c("strong",[e._v("A reference to a "),c("RouterLink",{attrs:{to:"/core/encoding.html"}},[c("code",[e._v("legacyAmino")])]),e._v(" codec.")],1),e._v(" Some parts of the SDK have not been migrated to use the "),c("code",[e._v("appCodec")]),e._v(" above, and are still hardcoded to use Amino. Other parts explicity use Amino for backwards compatibility. For these reasons, the application still holds a reference to the legacy Amino codec. Please note that the Amino codec will be removed from the SDK in the upcoming releases.")]),e._v(" "),c("li",[c("strong",[e._v("A reference to a "),c("RouterLink",{attrs:{to:"/building-modules/module-manager.html#manager"}},[e._v("module manager")])],1),e._v(" and a "),c("RouterLink",{attrs:{to:"/building-modules/module-manager.html#basicmanager"}},[e._v("basic module manager")]),e._v(". The module manager is an object that contains a list of the application's module. It facilitates operations related to these modules, like registering their "),c("RouterLink",{attrs:{to:"/core/baseapp.html#msg-services"}},[c("code",[e._v("Msg")]),e._v(" service")]),e._v(" and "),c("RouterLink",{attrs:{to:"/core/baseapp.html#grpc-query-services"}},[e._v("gRPC "),c("code",[e._v("Query")]),e._v(" service")]),e._v(", or setting the order of execution between modules for various functions like "),c("a",{attrs:{href:"#initchainer"}},[c("code",[e._v("InitChainer")])]),e._v(", "),c("a",{attrs:{href:"#beginblocker-and-endblocker"}},[c("code",[e._v("BeginBlocker")]),e._v(" and "),c("code",[e._v("EndBlocker")])]),e._v(".")],1)]),e._v(" "),c("p",[e._v("See an example of application type definition from "),c("code",[e._v("simapp")]),e._v(", the SDK's own app used for demo and testing purposes:")]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"CnZhciAoCglfIEFwcCAgICAgICAgICAgICAgICAgICAgID0gKCpTaW1BcHApKG5pbCkKCV8gc2VydmVydHlwZXMuQXBwbGljYXRpb24gPSAoKlNpbUFwcCkobmlsKQopCgovLyBTaW1BcHAgZXh0ZW5kcyBhbiBBQkNJIGFwcGxpY2F0aW9uLCBidXQgd2l0aCBtb3N0IG9mIGl0cyBwYXJhbWV0ZXJzIGV4cG9ydGVkLgovLyBUaGV5IGFyZSBleHBvcnRlZCBmb3IgY29udmVuaWVuY2UgaW4gY3JlYXRpbmcgaGVscGVyIGZ1bmN0aW9ucywgYXMgb2JqZWN0Ci8vIGNhcGFiaWxpdGllcyBhcmVuJ3QgbmVlZGVkIGZvciB0ZXN0aW5nLgp0eXBlIFNpbUFwcCBzdHJ1Y3QgewoJKmJhc2VhcHAuQmFzZUFwcAoJbGVnYWN5QW1pbm8gICAgICAgKmNvZGVjLkxlZ2FjeUFtaW5vCglhcHBDb2RlYyAgICAgICAgICBjb2RlYy5NYXJzaGFsZXIKCWludGVyZmFjZVJlZ2lzdHJ5IHR5cGVzLkludGVyZmFjZVJlZ2lzdHJ5CgoJaW52Q2hlY2tQZXJpb2QgdWludAoKCS8vIGtleXMgdG8gYWNjZXNzIHRoZSBzdWJzdG9yZXMKCWtleXMgICAgbWFwW3N0cmluZ10qc2RrLktWU3RvcmVLZXkKCXRrZXlzICAgbWFwW3N0cmluZ10qc2RrLlRyYW5zaWVudFN0b3JlS2V5CgltZW1LZXlzIG1hcFtzdHJpbmddKnNkay5NZW1vcnlTdG9yZUtleQoKCS8vIGtlZXBlcnMKCUFjY291bnRLZWVwZXIgICAgYXV0aGtlZXBlci5BY2NvdW50S2VlcGVyCglCYW5rS2VlcGVyICAgICAgIGJhbmtrZWVwZXIuS2VlcGVyCglDYXBhYmlsaXR5S2VlcGVyICpjYXBhYmlsaXR5a2VlcGVyLktlZXBlcgoJU3Rha2luZ0tlZXBlciAgICBzdGFraW5na2VlcGVyLktlZXBlcgoJU2xhc2hpbmdLZWVwZXIgICBzbGFzaGluZ2tlZXBlci5LZWVwZXIKCU1pbnRLZWVwZXIgICAgICAgbWludGtlZXBlci5LZWVwZXIKCURpc3RyS2VlcGVyICAgICAgZGlzdHJrZWVwZXIuS2VlcGVyCglHb3ZLZWVwZXIgICAgICAgIGdvdmtlZXBlci5LZWVwZXIKCUNyaXNpc0tlZXBlciAgICAgY3Jpc2lza2VlcGVyLktlZXBlcgoJVXBncmFkZUtlZXBlciAgICB1cGdyYWRla2VlcGVyLktlZXBlcgoJUGFyYW1zS2VlcGVyICAgICBwYXJhbXNrZWVwZXIuS2VlcGVyCglJQkNLZWVwZXIgICAgICAgICppYmNrZWVwZXIuS2VlcGVyIC8vIElCQyBLZWVwZXIgbXVzdCBiZSBhIHBvaW50ZXIgaW4gdGhlIGFwcCwgc28gd2UgY2FuIFNldFJvdXRlciBvbiBpdCBjb3JyZWN0bHkKCUV2aWRlbmNlS2VlcGVyICAgZXZpZGVuY2VrZWVwZXIuS2VlcGVyCglUcmFuc2ZlcktlZXBlciAgIGliY3RyYW5zZmVya2VlcGVyLktlZXBlcgoKCS8vIG1ha2Ugc2NvcGVkIGtlZXBlcnMgcHVibGljIGZvciB0ZXN0IHB1cnBvc2VzCglTY29wZWRJQkNLZWVwZXIgICAgICBjYXBhYmlsaXR5a2VlcGVyLlNjb3BlZEtlZXBlcgoJU2NvcGVkVHJhbnNmZXJLZWVwZXIgY2FwYWJpbGl0eWtlZXBlci5TY29wZWRLZWVwZXIKCVNjb3BlZElCQ01vY2tLZWVwZXIgIGNhcGFiaWxpdHlrZWVwZXIuU2NvcGVkS2VlcGVyCg=="}})],1),e._v(" "),c("h3",{attrs:{id:"constructor-function"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#constructor-function"}},[e._v("#")]),e._v(" Constructor Function")]),e._v(" "),c("p",[e._v("This function constructs a new application of the type defined in the section above. It must fulfill the "),c("code",[e._v("AppCreator")]),e._v(" signature in order to be used in the "),c("RouterLink",{attrs:{to:"/core/node.html#start-command"}},[c("code",[e._v("start")]),e._v(" command")]),e._v(" of the application's daemon command.")],1),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"CgkJLy8gUmVnaXN0ZXJUeFNlcnZpY2UgcmVnaXN0ZXJzIHRoZSBnUlBDIFF1ZXJ5IHNlcnZpY2UgZm9yIHR4IChzdWNoIGFzIHR4CgkJLy8gc2ltdWxhdGlvbiwgZmV0Y2hpbmcgdHhzIGJ5IGhhc2guLi4pLg=="}})],1),e._v(" "),c("p",[e._v("Here are the main actions performed by this function:")]),e._v(" "),c("ul",[c("li",[e._v("Instantiate a new "),c("RouterLink",{attrs:{to:"/core/encoding.html"}},[c("code",[e._v("codec")])]),e._v(" and initialize the "),c("code",[e._v("codec")]),e._v(" of each of the application's module using the "),c("RouterLink",{attrs:{to:"/building-modules/module-manager.html#basicmanager"}},[e._v("basic manager")])],1),e._v(" "),c("li",[e._v("Instantiate a new application with a reference to a "),c("code",[e._v("baseapp")]),e._v(" instance, a codec and all the appropriate store keys.")]),e._v(" "),c("li",[e._v("Instantiate all the "),c("a",{attrs:{href:"#keeper"}},[c("code",[e._v("keeper")]),e._v("s")]),e._v(" defined in the application's "),c("code",[e._v("type")]),e._v(" using the "),c("code",[e._v("NewKeeper")]),e._v(" function of each of the application's modules. Note that "),c("code",[e._v("keepers")]),e._v(" must be instantiated in the correct order, as the "),c("code",[e._v("NewKeeper")]),e._v(" of one module might require a reference to another module's "),c("code",[e._v("keeper")]),e._v(".")]),e._v(" "),c("li",[e._v("Instantiate the application's "),c("RouterLink",{attrs:{to:"/building-modules/module-manager.html#manager"}},[e._v("module manager")]),e._v(" with the "),c("a",{attrs:{href:"#application-module-interface"}},[c("code",[e._v("AppModule")])]),e._v(" object of each of the application's modules.")],1),e._v(" "),c("li",[e._v("With the module manager, initialize the application's "),c("RouterLink",{attrs:{to:"/core/baseapp.html#msg-services"}},[c("code",[e._v("Msg")]),e._v(" services")]),e._v(", "),c("RouterLink",{attrs:{to:"/core/baseapp.html#grpc-query-services"}},[e._v("gRPC "),c("code",[e._v("Query")]),e._v(" services")]),e._v(", "),c("RouterLink",{attrs:{to:"/core/baseapp.html#routing"}},[e._v("legacy "),c("code",[e._v("Msg")]),e._v(" routes")]),e._v(" and "),c("RouterLink",{attrs:{to:"/core/baseapp.html#query-routing"}},[e._v("legacy query routes")]),e._v(". When a transaction is relayed to the application by Tendermint via the ABCI, it is routed to the appropriate module's "),c("a",{attrs:{href:"#msg-services"}},[c("code",[e._v("Msg")]),e._v(" service")]),e._v(" using the routes defined here. Likewise, when a gRPC query request is received by the application, it is routed to the appropriate module's "),c("a",{attrs:{href:"#grpc-query-services"}},[c("code",[e._v("gRPC query service")])]),e._v(" using the gRPC routes defined here. The SDK still supports legacy "),c("code",[e._v("Msg")]),e._v("s and legacy Tendermint queries, which are routed using respectively the legacy "),c("code",[e._v("Msg")]),e._v(" routes and the legacy query routes.")],1),e._v(" "),c("li",[e._v("With the module manager, register the "),c("RouterLink",{attrs:{to:"/building-modules/invariants.html"}},[e._v("application's modules' invariants")]),e._v(". Invariants are variables (e.g. total supply of a token) that are evaluated at the end of each block. The process of checking invariants is done via a special module called the "),c("RouterLink",{attrs:{to:"/building-modules/invariants.html#invariant-registry"}},[c("code",[e._v("InvariantsRegistry")])]),e._v(". The value of the invariant should be equal to a predicted value defined in the module. Should the value be different than the predicted one, special logic defined in the invariant registry will be triggered (usually the chain is halted). This is useful to make sure no critical bug goes unnoticed and produces long-lasting effects that would be hard to fix.")],1),e._v(" "),c("li",[e._v("With the module manager, set the order of execution between the "),c("code",[e._v("InitGenesis")]),e._v(", "),c("code",[e._v("BegingBlocker")]),e._v(" and "),c("code",[e._v("EndBlocker")]),e._v(" functions of each of the "),c("a",{attrs:{href:"#application-module-interface"}},[e._v("application's modules")]),e._v(". Note that not all modules implement these functions.")]),e._v(" "),c("li",[e._v("Set the remainer of application's parameters:\n"),c("ul",[c("li",[c("a",{attrs:{href:"#initchainer"}},[c("code",[e._v("InitChainer")])]),e._v(": used to initialize the application when it is first started.")]),e._v(" "),c("li",[c("a",{attrs:{href:"#beginblocker-and-endlbocker"}},[c("code",[e._v("BeginBlocker")]),e._v(", "),c("code",[e._v("EndBlocker")])]),e._v(": called at the beginning and the end of every block).")]),e._v(" "),c("li",[c("RouterLink",{attrs:{to:"/core/baseapp.html#antehandler"}},[c("code",[e._v("anteHandler")])]),e._v(": used to handle fees and signature verification.")],1)])]),e._v(" "),c("li",[e._v("Mount the stores.")]),e._v(" "),c("li",[e._v("Return the application.")])]),e._v(" "),c("p",[e._v("Note that this function only creates an instance of the app, while the actual state is either carried over from the "),c("code",[e._v("~/.appd/data")]),e._v(" folder if the node is restarted, or generated from the genesis file if the node is started for the first time.")]),e._v(" "),c("p",[e._v("See an example of application constructor from "),c("code",[e._v("simapp")]),e._v(":")]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"CQlwYW5pYyhlcnIpCgl9CgoJRGVmYXVsdE5vZGVIb21lID0gZmlsZXBhdGguSm9pbih1c2VySG9tZURpciwgJnF1b3Q7LnNpbWFwcCZxdW90OykKfQoKLy8gTmV3U2ltQXBwIHJldHVybnMgYSByZWZlcmVuY2UgdG8gYW4gaW5pdGlhbGl6ZWQgU2ltQXBwLgpmdW5jIE5ld1NpbUFwcCgKCWxvZ2dlciBsb2cuTG9nZ2VyLCBkYiBkYm0uREIsIHRyYWNlU3RvcmUgaW8uV3JpdGVyLCBsb2FkTGF0ZXN0IGJvb2wsIHNraXBVcGdyYWRlSGVpZ2h0cyBtYXBbaW50NjRdYm9vbCwKCWhvbWVQYXRoIHN0cmluZywgaW52Q2hlY2tQZXJpb2QgdWludCwgZW5jb2RpbmdDb25maWcgc2ltYXBwcGFyYW1zLkVuY29kaW5nQ29uZmlnLAoJYXBwT3B0cyBzZXJ2ZXJ0eXBlcy5BcHBPcHRpb25zLCBiYXNlQXBwT3B0aW9ucyAuLi5mdW5jKCpiYXNlYXBwLkJhc2VBcHApLAopICpTaW1BcHAgewoKCS8vIFRPRE86IFJlbW92ZSBjZGMgaW4gZmF2b3Igb2YgYXBwQ29kZWMgb25jZSBhbGwgbW9kdWxlcyBhcmUgbWlncmF0ZWQuCglhcHBDb2RlYyA6PSBlbmNvZGluZ0NvbmZpZy5NYXJzaGFsZXIKCWxlZ2FjeUFtaW5vIDo9IGVuY29kaW5nQ29uZmlnLkFtaW5vCglpbnRlcmZhY2VSZWdpc3RyeSA6PSBlbmNvZGluZ0NvbmZpZy5JbnRlcmZhY2VSZWdpc3RyeQoKCWJBcHAgOj0gYmFzZWFwcC5OZXdCYXNlQXBwKGFwcE5hbWUsIGxvZ2dlciwgZGIsIGVuY29kaW5nQ29uZmlnLlR4Q29uZmlnLlR4RGVjb2RlcigpLCBiYXNlQXBwT3B0aW9ucy4uLikKCWJBcHAuU2V0Q29tbWl0TXVsdGlTdG9yZVRyYWNlcih0cmFjZVN0b3JlKQoJYkFwcC5TZXRBcHBWZXJzaW9uKHZlcnNpb24uVmVyc2lvbikKCWJBcHAuU2V0SW50ZXJmYWNlUmVnaXN0cnkoaW50ZXJmYWNlUmVnaXN0cnkpCgoJa2V5cyA6PSBzZGsuTmV3S1ZTdG9yZUtleXMoCgkJYXV0aHR5cGVzLlN0b3JlS2V5LCBiYW5rdHlwZXMuU3RvcmVLZXksIHN0YWtpbmd0eXBlcy5TdG9yZUtleSwKCQltaW50dHlwZXMuU3RvcmVLZXksIGRpc3RydHlwZXMuU3RvcmVLZXksIHNsYXNoaW5ndHlwZXMuU3RvcmVLZXksCgkJZ292dHlwZXMuU3RvcmVLZXksIHBhcmFtc3R5cGVzLlN0b3JlS2V5LCBpYmNob3N0LlN0b3JlS2V5LCB1cGdyYWRldHlwZXMuU3RvcmVLZXksCgkJZXZpZGVuY2V0eXBlcy5TdG9yZUtleSwgaWJjdHJhbnNmZXJ0eXBlcy5TdG9yZUtleSwgY2FwYWJpbGl0eXR5cGVzLlN0b3JlS2V5LAoJKQoJdGtleXMgOj0gc2RrLk5ld1RyYW5zaWVudFN0b3JlS2V5cyhwYXJhbXN0eXBlcy5UU3RvcmVLZXkpCgltZW1LZXlzIDo9IHNkay5OZXdNZW1vcnlTdG9yZUtleXMoY2FwYWJpbGl0eXR5cGVzLk1lbVN0b3JlS2V5KQoKCWFwcCA6PSAmYW1wO1NpbUFwcHsKCQlCYXNlQXBwOiAgICAgICAgICAgYkFwcCwKCQlsZWdhY3lBbWlubzogICAgICAgbGVnYWN5QW1pbm8sCgkJYXBwQ29kZWM6ICAgICAgICAgIGFwcENvZGVjLAoJCWludGVyZmFjZVJlZ2lzdHJ5OiBpbnRlcmZhY2VSZWdpc3RyeSwKCQlpbnZDaGVja1BlcmlvZDogICAgaW52Q2hlY2tQZXJpb2QsCgkJa2V5czogICAgICAgICAgICAgIGtleXMsCgkJdGtleXM6ICAgICAgICAgICAgIHRrZXlzLAoJCW1lbUtleXM6ICAgICAgICAgICBtZW1LZXlzLAoJfQoKCWFwcC5QYXJhbXNLZWVwZXIgPSBpbml0UGFyYW1zS2VlcGVyKGFwcENvZGVjLCBsZWdhY3lBbWlubywga2V5c1twYXJhbXN0eXBlcy5TdG9yZUtleV0sIHRrZXlzW3BhcmFtc3R5cGVzLlRTdG9yZUtleV0pCgoJLy8gc2V0IHRoZSBCYXNlQXBwJ3MgcGFyYW1ldGVyIHN0b3JlCgliQXBwLlNldFBhcmFtU3RvcmUoYXBwLlBhcmFtc0tlZXBlci5TdWJzcGFjZShiYXNlYXBwLlBhcmFtc3BhY2UpLldpdGhLZXlUYWJsZShwYXJhbXNrZWVwZXIuQ29uc2Vuc3VzUGFyYW1zS2V5VGFibGUoKSkpCgoJLy8gYWRkIGNhcGFiaWxpdHkga2VlcGVyIGFuZCBTY29wZVRvTW9kdWxlIGZvciBpYmMgbW9kdWxlCglhcHAuQ2FwYWJpbGl0eUtlZXBlciA9IGNhcGFiaWxpdHlrZWVwZXIuTmV3S2VlcGVyKGFwcENvZGVjLCBrZXlzW2NhcGFiaWxpdHl0eXBlcy5TdG9yZUtleV0sIG1lbUtleXNbY2FwYWJpbGl0eXR5cGVzLk1lbVN0b3JlS2V5XSkKCXNjb3BlZElCQ0tlZXBlciA6PSBhcHAuQ2FwYWJpbGl0eUtlZXBlci5TY29wZVRvTW9kdWxlKGliY2hvc3QuTW9kdWxlTmFtZSkKCXNjb3BlZFRyYW5zZmVyS2VlcGVyIDo9IGFwcC5DYXBhYmlsaXR5S2VlcGVyLlNjb3BlVG9Nb2R1bGUoaWJjdHJhbnNmZXJ0eXBlcy5Nb2R1bGVOYW1lKQoJLy8gTk9URTogdGhlIElCQyBtb2NrIGtlZXBlciBhbmQgYXBwbGljYXRpb24gbW9kdWxlIGlzIHVzZWQgb25seSBmb3IgdGVzdGluZyBjb3JlIElCQy4gRG8KCS8vIG5vdGUgcmVwbGljYXRlIGlmIHlvdSBkbyBub3QgbmVlZCB0byB0ZXN0IGNvcmUgSUJDIG9yIGxpZ2h0IGNsaWVudHMuCglzY29wZWRJQkNNb2NrS2VlcGVyIDo9IGFwcC5DYXBhYmlsaXR5S2VlcGVyLlNjb3BlVG9Nb2R1bGUoaWJjbW9jay5Nb2R1bGVOYW1lKQoKCS8vIGFkZCBrZWVwZXJzCglhcHAuQWNjb3VudEtlZXBlciA9IGF1dGhrZWVwZXIuTmV3QWNjb3VudEtlZXBlcigKCQlhcHBDb2RlYywga2V5c1thdXRodHlwZXMuU3RvcmVLZXldLCBhcHAuR2V0U3Vic3BhY2UoYXV0aHR5cGVzLk1vZHVsZU5hbWUpLCBhdXRodHlwZXMuUHJvdG9CYXNlQWNjb3VudCwgbWFjY1Blcm1zLAoJKQoJYXBwLkJhbmtLZWVwZXIgPSBiYW5ra2VlcGVyLk5ld0Jhc2VLZWVwZXIoCgkJYXBwQ29kZWMsIGtleXNbYmFua3R5cGVzLlN0b3JlS2V5XSwgYXBwLkFjY291bnRLZWVwZXIsIGFwcC5HZXRTdWJzcGFjZShiYW5rdHlwZXMuTW9kdWxlTmFtZSksIGFwcC5CbG9ja2VkQWRkcnMoKSwKCSkKCXN0YWtpbmdLZWVwZXIgOj0gc3Rha2luZ2tlZXBlci5OZXdLZWVwZXIoCgkJYXBwQ29kZWMsIGtleXNbc3Rha2luZ3R5cGVzLlN0b3JlS2V5XSwgYXBwLkFjY291bnRLZWVwZXIsIGFwcC5CYW5rS2VlcGVyLCBhcHAuR2V0U3Vic3BhY2Uoc3Rha2luZ3R5cGVzLk1vZHVsZU5hbWUpLAoJKQoJYXBwLk1pbnRLZWVwZXIgPSBtaW50a2VlcGVyLk5ld0tlZXBlcigKCQlhcHBDb2RlYywga2V5c1ttaW50dHlwZXMuU3RvcmVLZXldLCBhcHAuR2V0U3Vic3BhY2UobWludHR5cGVzLk1vZHVsZU5hbWUpLCAmYW1wO3N0YWtpbmdLZWVwZXIsCgkJYXBwLkFjY291bnRLZWVwZXIsIGFwcC5CYW5rS2VlcGVyLCBhdXRodHlwZXMuRmVlQ29sbGVjdG9yTmFtZSwKCSkKCWFwcC5EaXN0cktlZXBlciA9IGRpc3Rya2VlcGVyLk5ld0tlZXBlcigKCQlhcHBDb2RlYywga2V5c1tkaXN0cnR5cGVzLlN0b3JlS2V5XSwgYXBwLkdldFN1YnNwYWNlKGRpc3RydHlwZXMuTW9kdWxlTmFtZSksIGFwcC5BY2NvdW50S2VlcGVyLCBhcHAuQmFua0tlZXBlciwKCQkmYW1wO3N0YWtpbmdLZWVwZXIsIGF1dGh0eXBlcy5GZWVDb2xsZWN0b3JOYW1lLCBhcHAuTW9kdWxlQWNjb3VudEFkZHJzKCksCgkpCglhcHAuU2xhc2hpbmdLZWVwZXIgPSBzbGFzaGluZ2tlZXBlci5OZXdLZWVwZXIoCgkJYXBwQ29kZWMsIGtleXNbc2xhc2hpbmd0eXBlcy5TdG9yZUtleV0sICZhbXA7c3Rha2luZ0tlZXBlciwgYXBwLkdldFN1YnNwYWNlKHNsYXNoaW5ndHlwZXMuTW9kdWxlTmFtZSksCgkpCglhcHAuQ3Jpc2lzS2VlcGVyID0gY3Jpc2lza2VlcGVyLk5ld0tlZXBlcigKCQlhcHAuR2V0U3Vic3BhY2UoY3Jpc2lzdHlwZXMuTW9kdWxlTmFtZSksIGludkNoZWNrUGVyaW9kLCBhcHAuQmFua0tlZXBlciwgYXV0aHR5cGVzLkZlZUNvbGxlY3Rvck5hbWUsCgkpCglhcHAuVXBncmFkZUtlZXBlciA9IHVwZ3JhZGVrZWVwZXIuTmV3S2VlcGVyKHNraXBVcGdyYWRlSGVpZ2h0cywga2V5c1t1cGdyYWRldHlwZXMuU3RvcmVLZXldLCBhcHBDb2RlYywgaG9tZVBhdGgpCgoJLy8gcmVnaXN0ZXIgdGhlIHN0YWtpbmcgaG9va3MKCS8vIE5PVEU6IHN0YWtpbmdLZWVwZXIgYWJvdmUgaXMgcGFzc2VkIGJ5IHJlZmVyZW5jZSwgc28gdGhhdCBpdCB3aWxsIGNvbnRhaW4gdGhlc2UgaG9va3MKCWFwcC5TdGFraW5nS2VlcGVyID0gKnN0YWtpbmdLZWVwZXIuU2V0SG9va3MoCgkJc3Rha2luZ3R5cGVzLk5ld011bHRpU3Rha2luZ0hvb2tzKGFwcC5EaXN0cktlZXBlci5Ib29rcygpLCBhcHAuU2xhc2hpbmdLZWVwZXIuSG9va3MoKSksCgkpCgoJLy8gQ3JlYXRlIElCQyBLZWVwZXIKCWFwcC5JQkNLZWVwZXIgPSBpYmNrZWVwZXIuTmV3S2VlcGVyKAoJCWFwcENvZGVjLCBrZXlzW2liY2hvc3QuU3RvcmVLZXldLCBhcHAuU3Rha2luZ0tlZXBlciwgc2NvcGVkSUJDS2VlcGVyLAoJKQoKCS8vIHJlZ2lzdGVyIHRoZSBwcm9wb3NhbCB0eXBlcwoJZ292Um91dGVyIDo9IGdvdnR5cGVzLk5ld1JvdXRlcigpCglnb3ZSb3V0ZXIuQWRkUm91dGUoZ292dHlwZXMuUm91dGVyS2V5LCBnb3Z0eXBlcy5Qcm9wb3NhbEhhbmRsZXIpLgoJCUFkZFJvdXRlKHBhcmFtcHJvcG9zYWwuUm91dGVyS2V5LCBwYXJhbXMuTmV3UGFyYW1DaGFuZ2VQcm9wb3NhbEhhbmRsZXIoYXBwLlBhcmFtc0tlZXBlcikpLgoJCUFkZFJvdXRlKGRpc3RydHlwZXMuUm91dGVyS2V5LCBkaXN0ci5OZXdDb21tdW5pdHlQb29sU3BlbmRQcm9wb3NhbEhhbmRsZXIoYXBwLkRpc3RyS2VlcGVyKSkuCgkJQWRkUm91dGUodXBncmFkZXR5cGVzLlJvdXRlcktleSwgdXBncmFkZS5OZXdTb2Z0d2FyZVVwZ3JhZGVQcm9wb3NhbEhhbmRsZXIoYXBwLlVwZ3JhZGVLZWVwZXIpKS4KCQlBZGRSb3V0ZShpYmNob3N0LlJvdXRlcktleSwgaWJjY2xpZW50Lk5ld0NsaWVudFVwZGF0ZVByb3Bvc2FsSGFuZGxlcihhcHAuSUJDS2VlcGVyLkNsaWVudEtlZXBlcikpCglhcHAuR292S2VlcGVyID0gZ292a2VlcGVyLk5ld0tlZXBlcigKCQlhcHBDb2RlYywga2V5c1tnb3Z0eXBlcy5TdG9yZUtleV0sIGFwcC5HZXRTdWJzcGFjZShnb3Z0eXBlcy5Nb2R1bGVOYW1lKSwgYXBwLkFjY291bnRLZWVwZXIsIGFwcC5CYW5rS2VlcGVyLAoJCSZhbXA7c3Rha2luZ0tlZXBlciwgZ292Um91dGVyLAoJKQoKCS8vIENyZWF0ZSBUcmFuc2ZlciBLZWVwZXJzCglhcHAuVHJhbnNmZXJLZWVwZXIgPSBpYmN0cmFuc2ZlcmtlZXBlci5OZXdLZWVwZXIoCgkJYXBwQ29kZWMsIGtleXNbaWJjdHJhbnNmZXJ0eXBlcy5TdG9yZUtleV0sIGFwcC5HZXRTdWJzcGFjZShpYmN0cmFuc2ZlcnR5cGVzLk1vZHVsZU5hbWUpLAoJCWFwcC5JQkNLZWVwZXIuQ2hhbm5lbEtlZXBlciwgJmFtcDthcHAuSUJDS2VlcGVyLlBvcnRLZWVwZXIsCgkJYXBwLkFjY291bnRLZWVwZXIsIGFwcC5CYW5rS2VlcGVyLCBzY29wZWRUcmFuc2ZlcktlZXBlciwKCSkKCXRyYW5zZmVyTW9kdWxlIDo9IHRyYW5zZmVyLk5ld0FwcE1vZHVsZShhcHAuVHJhbnNmZXJLZWVwZXIpCgoJLy8gTk9URTogdGhlIElCQyBtb2NrIGtlZXBlciBhbmQgYXBwbGljYXRpb24gbW9kdWxlIGlzIHVzZWQgb25seSBmb3IgdGVzdGluZyBjb3JlIElCQy4gRG8KCS8vIG5vdGUgcmVwbGljYXRlIGlmIHlvdSBkbyBub3QgbmVlZCB0byB0ZXN0IGNvcmUgSUJDIG9yIGxpZ2h0IGNsaWVudHMuCgltb2NrTW9kdWxlIDo9IGliY21vY2suTmV3QXBwTW9kdWxlKHNjb3BlZElCQ01vY2tLZWVwZXIpCgoJLy8gQ3JlYXRlIHN0YXRpYyBJQkMgcm91dGVyLCBhZGQgdHJhbnNmZXIgcm91dGUsIHRoZW4gc2V0IGFuZCBzZWFsIGl0CglpYmNSb3V0ZXIgOj0gcG9ydHR5cGVzLk5ld1JvdXRlcigpCglpYmNSb3V0ZXIuQWRkUm91dGUoaWJjdHJhbnNmZXJ0eXBlcy5Nb2R1bGVOYW1lLCB0cmFuc2Zlck1vZHVsZSkKCWliY1JvdXRlci5BZGRSb3V0ZShpYmNtb2NrLk1vZHVsZU5hbWUsIG1vY2tNb2R1bGUpCglhcHAuSUJDS2VlcGVyLlNldFJvdXRlcihpYmNSb3V0ZXIpCgoJLy8gY3JlYXRlIGV2aWRlbmNlIGtlZXBlciB3aXRoIHJvdXRlcgoJZXZpZGVuY2VLZWVwZXIgOj0gZXZpZGVuY2VrZWVwZXIuTmV3S2VlcGVyKAoJCWFwcENvZGVjLCBrZXlzW2V2aWRlbmNldHlwZXMuU3RvcmVLZXldLCAmYW1wO2FwcC5TdGFraW5nS2VlcGVyLCBhcHAuU2xhc2hpbmdLZWVwZXIsCgkpCgkvLyBJZiBldmlkZW5jZSBuZWVkcyB0byBiZSBoYW5kbGVkIGZvciB0aGUgYXBwLCBzZXQgcm91dGVzIGluIHJvdXRlciBoZXJlIGFuZCBzZWFsCglhcHAuRXZpZGVuY2VLZWVwZXIgPSAqZXZpZGVuY2VLZWVwZXIKCgkvKioqKiAgTW9kdWxlIE9wdGlvbnMgKioqKi8KCgkvLyBOT1RFOiB3ZSBtYXkgY29uc2lkZXIgcGFyc2luZyBgYXBwT3B0c2AgaW5zaWRlIG1vZHVsZSBjb25zdHJ1Y3RvcnMuIEZvciB0aGUgbW9tZW50CgkvLyB3ZSBwcmVmZXIgdG8gYmUgbW9yZSBzdHJpY3QgaW4gd2hhdCBhcmd1bWVudHMgdGhlIG1vZHVsZXMgZXhwZWN0LgoJdmFyIHNraXBHZW5lc2lzSW52YXJpYW50cyA9IGNhc3QuVG9Cb29sKGFwcE9wdHMuR2V0KGNyaXNpcy5GbGFnU2tpcEdlbmVzaXNJbnZhcmlhbnRzKSkKCgkvLyBOT1RFOiBBbnkgbW9kdWxlIGluc3RhbnRpYXRlZCBpbiB0aGUgbW9kdWxlIG1hbmFnZXIgdGhhdCBpcyBsYXRlciBtb2RpZmllZAoJLy8gbXVzdCBiZSBwYXNzZWQgYnkgcmVmZXJlbmNlIGhlcmUuCglhcHAubW0gPSBtb2R1bGUuTmV3TWFuYWdlcigKCQlnZW51dGlsLk5ld0FwcE1vZHVsZSgKCQkJYXBwLkFjY291bnRLZWVwZXIsIGFwcC5TdGFraW5nS2VlcGVyLCBhcHAuQmFzZUFwcC5EZWxpdmVyVHgsCgkJCWVuY29kaW5nQ29uZmlnLlR4Q29uZmlnLAoJCSksCgkJYXV0aC5OZXdBcHBNb2R1bGUoYXBwQ29kZWMsIGFwcC5BY2NvdW50S2VlcGVyLCBhdXRoc2ltcy5SYW5kb21HZW5lc2lzQWNjb3VudHMpLAoJCXZlc3RpbmcuTmV3QXBwTW9kdWxlKGFwcC5BY2NvdW50S2VlcGVyLCBhcHAuQmFua0tlZXBlciksCgkJYmFuay5OZXdBcHBNb2R1bGUoYXBwQ29kZWMsIGFwcC5CYW5rS2VlcGVyLCBhcHAuQWNjb3VudEtlZXBlciksCgkJY2FwYWJpbGl0eS5OZXdBcHBNb2R1bGUoYXBwQ29kZWMsICphcHAuQ2FwYWJpbGl0eUtlZXBlciksCgkJY3Jpc2lzLk5ld0FwcE1vZHVsZSgmYW1wO2FwcC5DcmlzaXNLZWVwZXIsIHNraXBHZW5lc2lzSW52YXJpYW50cyksCgkJZ292Lk5ld0FwcE1vZHVsZShhcHBDb2RlYywgYXBwLkdvdktlZXBlciwgYXBwLkFjY291bnRLZWVwZXIsIGFwcC5CYW5rS2VlcGVyKSwKCQltaW50Lk5ld0FwcE1vZHVsZShhcHBDb2RlYywgYXBwLk1pbnRLZWVwZXIsIGFwcC5BY2NvdW50S2VlcGVyKSwKCQlzbGFzaGluZy5OZXdBcHBNb2R1bGUoYXBwQ29kZWMsIGFwcC5TbGFzaGluZ0tlZXBlciwgYXBwLkFjY291bnRLZWVwZXIsIGFwcC5CYW5rS2VlcGVyLCBhcHAuU3Rha2luZ0tlZXBlciksCgkJZGlzdHIuTmV3QXBwTW9kdWxlKGFwcENvZGVjLCBhcHAuRGlzdHJLZWVwZXIsIGFwcC5BY2NvdW50S2VlcGVyLCBhcHAuQmFua0tlZXBlciwgYXBwLlN0YWtpbmdLZWVwZXIpLAoJCXN0YWtpbmcuTmV3QXBwTW9kdWxlKGFwcENvZGVjLCBhcHAuU3Rha2luZ0tlZXBlciwgYXBwLkFjY291bnRLZWVwZXIsIGFwcC5CYW5rS2VlcGVyKSwKCQl1cGdyYWRlLk5ld0FwcE1vZHVsZShhcHAuVXBncmFkZUtlZXBlciksCgkJZXZpZGVuY2UuTmV3QXBwTW9kdWxlKGFwcC5FdmlkZW5jZUtlZXBlciksCgkJaWJjLk5ld0FwcE1vZHVsZShhcHAuSUJDS2VlcGVyKSwKCQlwYXJhbXMuTmV3QXBwTW9kdWxlKGFwcC5QYXJhbXNLZWVwZXIpLAoJCXRyYW5zZmVyTW9kdWxlLAoJKQoKCS8vIER1cmluZyBiZWdpbiBibG9jayBzbGFzaGluZyBoYXBwZW5zIGFmdGVyIGRpc3RyLkJlZ2luQmxvY2tlciBzbyB0aGF0CgkvLyB0aGVyZSBpcyBub3RoaW5nIGxlZnQgb3ZlciBpbiB0aGUgdmFsaWRhdG9yIGZlZSBwb29sLCBzbyBhcyB0byBrZWVwIHRoZQoJLy8gQ2FuV2l0aGRyYXdJbnZhcmlhbnQgaW52YXJpYW50LgoJLy8gTk9URTogc3Rha2luZyBtb2R1bGUgaXMgcmVxdWlyZWQgaWYgSGlzdG9yaWNhbEVudHJpZXMgcGFyYW0gJmd0OyAwCglhcHAubW0uU2V0T3JkZXJCZWdpbkJsb2NrZXJzKAoJCXVwZ3JhZGV0eXBlcy5Nb2R1bGVOYW1lLCBtaW50dHlwZXMuTW9kdWxlTmFtZSwgZGlzdHJ0eXBlcy5Nb2R1bGVOYW1lLCBzbGFzaGluZ3R5cGVzLk1vZHVsZU5hbWUsCgkJZXZpZGVuY2V0eXBlcy5Nb2R1bGVOYW1lLCBzdGFraW5ndHlwZXMuTW9kdWxlTmFtZSwgaWJjaG9zdC5Nb2R1bGVOYW1lLAoJKQoJYXBwLm1tLlNldE9yZGVyRW5kQmxvY2tlcnMoY3Jpc2lzdHlwZXMuTW9kdWxlTmFtZSwgZ292dHlwZXMuTW9kdWxlTmFtZSwgc3Rha2luZ3R5cGVzLk1vZHVsZU5hbWUpCgoJLy8gTk9URTogVGhlIGdlbnV0aWxzIG1vZHVsZSBtdXN0IG9jY3VyIGFmdGVyIHN0YWtpbmcgc28gdGhhdCBwb29scyBhcmUKCS8vIHByb3Blcmx5IGluaXRpYWxpemVkIHdpdGggdG9rZW5zIGZyb20gZ2VuZXNpcyBhY2NvdW50cy4KCS8vIE5PVEU6IENhcGFiaWxpdHkgbW9kdWxlIG11c3Qgb2NjdXIgZmlyc3Qgc28gdGhhdCBpdCBjYW4gaW5pdGlhbGl6ZSBhbnkgY2FwYWJpbGl0aWVzCgkvLyBzbyB0aGF0IG90aGVyIG1vZHVsZXMgdGhhdCB3YW50IHRvIGNyZWF0ZSBvciBjbGFpbSBjYXBhYmlsaXRpZXMgYWZ0ZXJ3YXJkcyBpbiBJbml0Q2hhaW4KCS8vIGNhbiBkbyBzbyBzYWZlbHkuCglhcHAubW0uU2V0T3JkZXJJbml0R2VuZXNpcygKCQljYXBhYmlsaXR5dHlwZXMuTW9kdWxlTmFtZSwgYXV0aHR5cGVzLk1vZHVsZU5hbWUsIGJhbmt0eXBlcy5Nb2R1bGVOYW1lLCBkaXN0cnR5cGVzLk1vZHVsZU5hbWUsIHN0YWtpbmd0eXBlcy5Nb2R1bGVOYW1lLAoJCXNsYXNoaW5ndHlwZXMuTW9kdWxlTmFtZSwgZ292dHlwZXMuTW9kdWxlTmFtZSwgbWludHR5cGVzLk1vZHVsZU5hbWUsIGNyaXNpc3R5cGVzLk1vZHVsZU5hbWUsCgkJaWJjaG9zdC5Nb2R1bGVOYW1lLCBnZW51dGlsdHlwZXMuTW9kdWxlTmFtZSwgZXZpZGVuY2V0eXBlcy5Nb2R1bGVOYW1lLCBpYmN0cmFuc2ZlcnR5cGVzLk1vZHVsZU5hbWUsCgkpCgoJYXBwLm1tLlJlZ2lzdGVySW52YXJpYW50cygmYW1wO2FwcC5DcmlzaXNLZWVwZXIpCglhcHAubW0uUmVnaXN0ZXJSb3V0ZXMoYXBwLlJvdXRlcigpLCBhcHAuUXVlcnlSb3V0ZXIoKSwgZW5jb2RpbmdDb25maWcuQW1pbm8pCglhcHAubW0uUmVnaXN0ZXJTZXJ2aWNlcyhtb2R1bGUuTmV3Q29uZmlndXJhdG9yKGFwcC5Nc2dTZXJ2aWNlUm91dGVyKCksIGFwcC5HUlBDUXVlcnlSb3V0ZXIoKSkpCgoJLy8gYWRkIHRlc3QgZ1JQQyBzZXJ2aWNlIGZvciB0ZXN0aW5nIGdSUEMgcXVlcmllcyBpbiBpc29sYXRpb24KCXRlc3RkYXRhLlJlZ2lzdGVyUXVlcnlTZXJ2ZXIoYXBwLkdSUENRdWVyeVJvdXRlcigpLCB0ZXN0ZGF0YS5RdWVyeUltcGx7fSkKCgkvLyBjcmVhdGUgdGhlIHNpbXVsYXRpb24gbWFuYWdlciBhbmQgZGVmaW5lIHRoZSBvcmRlciBvZiB0aGUgbW9kdWxlcyBmb3IgZGV0ZXJtaW5pc3RpYyBzaW11bGF0aW9ucwoJLy8KCS8vIE5PVEU6IHRoaXMgaXMgbm90IHJlcXVpcmVkIGFwcHMgdGhhdCBkb24ndCB1c2UgdGhlIHNpbXVsYXRvciBmb3IgZnV6eiB0ZXN0aW5nCgkvLyB0cmFuc2FjdGlvbnMKCWFwcC5zbSA9IG1vZHVsZS5OZXdTaW11bGF0aW9uTWFuYWdlcigKCQlhdXRoLk5ld0FwcE1vZHVsZShhcHBDb2RlYywgYXBwLkFjY291bnRLZWVwZXIsIGF1dGhzaW1zLlJhbmRvbUdlbmVzaXNBY2NvdW50cyksCgkJYmFuay5OZXdBcHBNb2R1bGUoYXBwQ29kZWMsIGFwcC5CYW5rS2VlcGVyLCBhcHAuQWNjb3VudEtlZXBlciksCgkJY2FwYWJpbGl0eS5OZXdBcHBNb2R1bGUoYXBwQ29kZWMsICphcHAuQ2FwYWJpbGl0eUtlZXBlciksCgkJZ292Lk5ld0FwcE1vZHVsZShhcHBDb2RlYywgYXBwLkdvdktlZXBlciwgYXBwLkFjY291bnRLZWVwZXIsIGFwcC5CYW5rS2VlcGVyKSwKCQltaW50Lk5ld0FwcE1vZHVsZShhcHBDb2RlYywgYXBwLk1pbnRLZWVwZXIsIGFwcC5BY2NvdW50S2VlcGVyKSwKCQlzdGFraW5nLk5ld0FwcE1vZHVsZShhcHBDb2RlYywgYXBwLlN0YWtpbmdLZWVwZXIsIGFwcC5BY2NvdW50S2VlcGVyLCBhcHAuQmFua0tlZXBlciksCgkJZGlzdHIuTmV3QXBwTW9kdWxlKGFwcENvZGVjLCBhcHAuRGlzdHJLZWVwZXIsIGFwcC5BY2NvdW50S2VlcGVyLCBhcHAuQmFua0tlZXBlciwgYXBwLlN0YWtpbmdLZWVwZXIpLAoJCXNsYXNoaW5nLk5ld0FwcE1vZHVsZShhcHBDb2RlYywgYXBwLlNsYXNoaW5nS2VlcGVyLCBhcHAuQWNjb3VudEtlZXBlciwgYXBwLkJhbmtLZWVwZXIsIGFwcC5TdGFraW5nS2VlcGVyKSwKCQlwYXJhbXMuTmV3QXBwTW9kdWxlKGFwcC5QYXJhbXNLZWVwZXIpLAoJCWV2aWRlbmNlLk5ld0FwcE1vZHVsZShhcHAuRXZpZGVuY2VLZWVwZXIpLAoJCWliYy5OZXdBcHBNb2R1bGUoYXBwLklCQ0tlZXBlciksCgkJdHJhbnNmZXJNb2R1bGUsCgkpCgoJYXBwLnNtLlJlZ2lzdGVyU3RvcmVEZWNvZGVycygpCgoJLy8gaW5pdGlhbGl6ZSBzdG9yZXMKCWFwcC5Nb3VudEtWU3RvcmVzKGtleXMpCglhcHAuTW91bnRUcmFuc2llbnRTdG9yZXModGtleXMpCglhcHAuTW91bnRNZW1vcnlTdG9yZXMobWVtS2V5cykKCgkvLyBpbml0aWFsaXplIEJhc2VBcHAKCWFwcC5TZXRJbml0Q2hhaW5lcihhcHAuSW5pdENoYWluZXIpCglhcHAuU2V0QmVnaW5CbG9ja2VyKGFwcC5CZWdpbkJsb2NrZXIpCglhcHAuU2V0QW50ZUhhbmRsZXIoCgkJYW50ZS5OZXdBbnRlSGFuZGxlcigKCQkJYXBwLkFjY291bnRLZWVwZXIsIGFwcC5CYW5rS2VlcGVyLCBhbnRlLkRlZmF1bHRTaWdWZXJpZmljYXRpb25HYXNDb25zdW1lciwKCQkJZW5jb2RpbmdDb25maWcuVHhDb25maWcuU2lnbk1vZGVIYW5kbGVyKCksCgkJKSwKCSkKCWFwcC5TZXRFbmRCbG9ja2VyKGFwcC5FbmRCbG9ja2VyKQoKCWlmIGxvYWRMYXRlc3QgewoJCWlmIGVyciA6PSBhcHAuTG9hZExhdGVzdFZlcnNpb24oKTsgZXJyICE9IG5pbCB7CgkJCXRtb3MuRXhpdChlcnIuRXJyb3IoKSkKCQl9CgoJCS8vIEluaXRpYWxpemUgYW5kIHNlYWwgdGhlIGNhcGFiaWxpdHkga2VlcGVyIHNvIGFsbCBwZXJzaXN0ZW50IGNhcGFiaWxpdGllcwoJCS8vIGFyZSBsb2FkZWQgaW4tbWVtb3J5IGFuZCBwcmV2ZW50IGFueSBmdXJ0aGVyIG1vZHVsZXMgZnJvbSBjcmVhdGluZyBzY29wZWQKCQkvLyBzdWIta2VlcGVycy4KCQkvLyBUaGlzIG11c3QgYmUgZG9uZSBkdXJpbmcgY3JlYXRpb24gb2YgYmFzZWFwcCByYXRoZXIgdGhhbiBpbiBJbml0Q2hhaW4gc28KCQkvLyB0aGF0IGluLW1lbW9yeSBjYXBhYmlsaXRpZXMgZ2V0IHJlZ2VuZXJhdGVkIG9uIGFwcCByZXN0YXJ0LgoJCS8vIE5vdGUgdGhhdCBzaW5jZSB0aGlzIHJlYWRzIGZyb20gdGhlIHN0b3JlLCB3ZSBjYW4gb25seSBwZXJmb3JtIGl0IHdoZW4KCQkvLyBgbG9hZExhdGVzdGAgaXMgc2V0IHRvIHRydWUuCgkJY3R4IDo9IGFwcC5CYXNlQXBwLk5ld1VuY2FjaGVkQ29udGV4dCh0cnVlLCB0bXByb3RvLkhlYWRlcnt9KQ=="}})],1),e._v(" "),c("h3",{attrs:{id:"initchainer"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#initchainer"}},[e._v("#")]),e._v(" InitChainer")]),e._v(" "),c("p",[e._v("The "),c("code",[e._v("InitChainer")]),e._v(" is a function that initializes the state of the application from a genesis file (i.e. token balances of genesis accounts). It is called when the application receives the "),c("code",[e._v("InitChain")]),e._v(" message from the Tendermint engine, which happens when the node is started at "),c("code",[e._v("appBlockHeight == 0")]),e._v(" (i.e. on genesis). The application must set the "),c("code",[e._v("InitChainer")]),e._v(" in its "),c("a",{attrs:{href:"#constructor-function"}},[e._v("constructor")]),e._v(" via the "),c("a",{attrs:{href:"https://godoc.org/github.com/cosmos/cosmos-sdk/baseapp#BaseApp.SetInitChainer",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("SetInitChainer")]),c("OutboundLink")],1),e._v(" method.")]),e._v(" "),c("p",[e._v("In general, the "),c("code",[e._v("InitChainer")]),e._v(" is mostly composed of the "),c("RouterLink",{attrs:{to:"/building-modules/genesis.html#initgenesis"}},[c("code",[e._v("InitGenesis")])]),e._v(" function of each of the application's modules. This is done by calling the "),c("code",[e._v("InitGenesis")]),e._v(" function of the module manager, which in turn will call the "),c("code",[e._v("InitGenesis")]),e._v(" function of each of the modules it contains. Note that the order in which the modules' "),c("code",[e._v("InitGenesis")]),e._v(" functions must be called has to be set in the module manager using the "),c("RouterLink",{attrs:{to:"/building-modules/module-manager.html"}},[e._v("module manager's")]),e._v(" "),c("code",[e._v("SetOrderInitGenesis")]),e._v(" method. This is done in the "),c("a",{attrs:{href:"#application-constructor"}},[e._v("application's constructor")]),e._v(", and the "),c("code",[e._v("SetOrderInitGenesis")]),e._v(" has to be called before the "),c("code",[e._v("SetInitChainer")]),e._v(".")],1),e._v(" "),c("p",[e._v("See an example of an "),c("code",[e._v("InitChainer")]),e._v(" from "),c("code",[e._v("simapp")]),e._v(":")]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyAoYXBwICpTaW1BcHApIE5hbWUoKSBzdHJpbmcgeyByZXR1cm4gYXBwLkJhc2VBcHAuTmFtZSgpIH0KCi8vIEJlZ2luQmxvY2tlciBhcHBsaWNhdGlvbiB1cGRhdGVzIGV2ZXJ5IGJlZ2luIGJsb2NrCmZ1bmMgKGFwcCAqU2ltQXBwKSBCZWdpbkJsb2NrZXIoY3R4IHNkay5Db250ZXh0LCByZXEgYWJjaS5SZXF1ZXN0QmVnaW5CbG9jaykgYWJjaS5SZXNwb25zZUJlZ2luQmxvY2sgewoJcmV0dXJuIGFwcC5tbS5CZWdpbkJsb2NrKGN0eCwgcmVxKQp9CgovLyBFbmRCbG9ja2VyIGFwcGxpY2F0aW9uIHVwZGF0ZXMgZXZlcnkgZW5kIGJsb2Nr"}})],1),e._v(" "),c("h3",{attrs:{id:"beginblocker-and-endblocker"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#beginblocker-and-endblocker"}},[e._v("#")]),e._v(" BeginBlocker and EndBlocker")]),e._v(" "),c("p",[e._v("The SDK offers developers the possibility to implement automatic execution of code as part of their application. This is implemented through two function called "),c("code",[e._v("BeginBlocker")]),e._v(" and "),c("code",[e._v("EndBlocker")]),e._v(". They are called when the application receives respectively the "),c("code",[e._v("BeginBlock")]),e._v(" and "),c("code",[e._v("EndBlock")]),e._v(" messages from the Tendermint engine, which happens at the beginning and at the end of each block. The application must set the "),c("code",[e._v("BeginBlocker")]),e._v(" and "),c("code",[e._v("EndBlocker")]),e._v(" in its "),c("a",{attrs:{href:"#constructor-function"}},[e._v("constructor")]),e._v(" via the "),c("a",{attrs:{href:"https://godoc.org/github.com/cosmos/cosmos-sdk/baseapp#BaseApp.SetBeginBlocker",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("SetBeginBlocker")]),c("OutboundLink")],1),e._v(" and "),c("a",{attrs:{href:"https://godoc.org/github.com/cosmos/cosmos-sdk/baseapp#BaseApp.SetEndBlocker",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("SetEndBlocker")]),c("OutboundLink")],1),e._v(" methods.")]),e._v(" "),c("p",[e._v("In general, the "),c("code",[e._v("BeginBlocker")]),e._v(" and "),c("code",[e._v("EndBlocker")]),e._v(" functions are mostly composed of the "),c("RouterLink",{attrs:{to:"/building-modules/beginblock-endblock.html"}},[c("code",[e._v("BeginBlock")]),e._v(" and "),c("code",[e._v("EndBlock")])]),e._v(" functions of each of the application's modules. This is done by calling the "),c("code",[e._v("BeginBlock")]),e._v(" and "),c("code",[e._v("EndBlock")]),e._v(" functions of the module manager, which in turn will call the "),c("code",[e._v("BeginBLock")]),e._v(" and "),c("code",[e._v("EndBlock")]),e._v(" functions of each of the modules it contains. Note that the order in which the modules' "),c("code",[e._v("BegingBlock")]),e._v(" and "),c("code",[e._v("EndBlock")]),e._v(" functions must be called has to be set in the module manager using the "),c("code",[e._v("SetOrderBeginBlock")]),e._v(" and "),c("code",[e._v("SetOrderEndBlock")]),e._v(" methods respectively. This is done via the "),c("RouterLink",{attrs:{to:"/building-modules/module-manager.html"}},[e._v("module manager")]),e._v(" in the "),c("a",{attrs:{href:"#application-constructor"}},[e._v("application's constructor")]),e._v(", and the "),c("code",[e._v("SetOrderBeginBlock")]),e._v(" and "),c("code",[e._v("SetOrderEndBlock")]),e._v(" methods have to be called before the "),c("code",[e._v("SetBeginBlocker")]),e._v(" and "),c("code",[e._v("SetEndBlocker")]),e._v(" functions.")],1),e._v(" "),c("p",[e._v("As a sidenote, it is important to remember that application-specific blockchains are deterministic. Developers must be careful not to introduce non-determinism in "),c("code",[e._v("BeginBlocker")]),e._v(" or "),c("code",[e._v("EndBlocker")]),e._v(", and must also be careful not to make them too computationally expensive, as "),c("RouterLink",{attrs:{to:"/basics/gas-fees.html"}},[e._v("gas")]),e._v(" does not constrain the cost of "),c("code",[e._v("BeginBlocker")]),e._v(" and "),c("code",[e._v("EndBlocker")]),e._v(" execution.")],1),e._v(" "),c("p",[e._v("See an example of "),c("code",[e._v("BeginBlocker")]),e._v(" and "),c("code",[e._v("EndBlocker")]),e._v(" functions from "),c("code",[e._v("simapp")])]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ci8vIE1ha2VDb2RlY3MgY29uc3RydWN0cyB0aGUgKnN0ZC5Db2RlYyBhbmQgKmNvZGVjLkxlZ2FjeUFtaW5vIGluc3RhbmNlcyB1c2VkIGJ5Ci8vIHNpbWFwcC4gSXQgaXMgdXNlZnVsIGZvciB0ZXN0cyBhbmQgY2xpZW50cyB3aG8gZG8gbm90IHdhbnQgdG8gY29uc3RydWN0IHRoZQovLyBmdWxsIHNpbWFwcApmdW5jIE1ha2VDb2RlY3MoKSAoY29kZWMuTWFyc2hhbGVyLCAqY29kZWMuTGVnYWN5QW1pbm8pIHsKCWNvbmZpZyA6PSBNYWtlVGVzdEVuY29kaW5nQ29uZmlnKCkKCXJldHVybiBjb25maWcuTWFyc2hhbGVyLCBjb25maWcuQW1pbm8KfQo="}})],1),e._v(" "),c("h3",{attrs:{id:"register-codec"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#register-codec"}},[e._v("#")]),e._v(" Register Codec")]),e._v(" "),c("p",[e._v("The "),c("code",[e._v("EncodingConfig")]),e._v(" structure is the last important part of the "),c("code",[e._v("app.go")]),e._v(" file. The goal of this structure is to define the codecs that will be used throughout the app.")]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gRW5jb2RpbmdDb25maWcgc3BlY2lmaWVzIHRoZSBjb25jcmV0ZSBlbmNvZGluZyB0eXBlcyB0byB1c2UgZm9yIGEgZ2l2ZW4gYXBwLgovLyBUaGlzIGlzIHByb3ZpZGVkIGZvciBjb21wYXRpYmlsaXR5IGJldHdlZW4gcHJvdG9idWYgYW5kIGFtaW5vIGltcGxlbWVudGF0aW9ucy4KdHlwZSBFbmNvZGluZ0NvbmZpZyBzdHJ1Y3QgewoJSW50ZXJmYWNlUmVnaXN0cnkgdHlwZXMuSW50ZXJmYWNlUmVnaXN0cnkKCU1hcnNoYWxlciAgICAgICAgIGNvZGVjLk1hcnNoYWxlcgoJVHhDb25maWcgICAgICAgICAgY2xpZW50LlR4Q29uZmlnCglBbWlubyAgICAgICAgICAgICAqY29kZWMuTGVnYWN5QW1pbm8KfQ=="}})],1),e._v(" "),c("p",[e._v("Here are descriptions of what each of the four fields means:")]),e._v(" "),c("ul",[c("li",[c("code",[e._v("InterfaceRegistry")]),e._v(": The "),c("code",[e._v("InterfaceRegistry")]),e._v(' is used by the Protobuf codec to handle interfaces, which are encoded and decoded (we also say "unpacked") using '),c("a",{attrs:{href:"https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/any.proto",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("google.protobuf.Any")]),c("OutboundLink")],1),e._v(". "),c("code",[e._v("Any")]),e._v(" could be thought as a struct which contains a "),c("code",[e._v("type_url")]),e._v(" (name of a concrete type implementing the interface) and a "),c("code",[e._v("value")]),e._v(" (its encoded bytes). "),c("code",[e._v("InterfaceRegistry")]),e._v(" provides a mechanism for registering interfaces and implementations that can be safely unpacked from "),c("code",[e._v("Any")]),e._v(". Each of the application's modules implements the "),c("code",[e._v("RegisterInterfaces")]),e._v(" method, which can be used to register the module's own interfaces and implementations.\n"),c("ul",[c("li",[e._v("You can read more about Any in "),c("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/master/docs/architecture/adr-019-protobuf-state-encoding.md#usage-of-any-to-encode-interfaces",target:"_blank",rel:"noopener noreferrer"}},[e._v("ADR-19"),c("OutboundLink")],1),e._v(".")]),e._v(" "),c("li",[e._v("To go more into details, the SDK uses an implementation of the Protobuf specification called "),c("a",{attrs:{href:"https://github.com/gogo/protobuf",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("gogoprotobuf")]),c("OutboundLink")],1),e._v(". By default, the "),c("a",{attrs:{href:"https://godoc.org/github.com/gogo/protobuf/types",target:"_blank",rel:"noopener noreferrer"}},[e._v("gogo protobuf implementation of "),c("code",[e._v("Any")]),c("OutboundLink")],1),e._v(" uses "),c("a",{attrs:{href:"https://github.com/gogo/protobuf/blob/master/proto/properties.go#L540",target:"_blank",rel:"noopener noreferrer"}},[e._v("global type registration"),c("OutboundLink")],1),e._v(" to decode values packed in "),c("code",[e._v("Any")]),e._v(" into concrete Go types. This introduces a vulnerability where any malicious module in the dependency tree could registry a type with the global protobuf registry and cause it to be loaded and unmarshaled by a transaction that referenced it in the "),c("code",[e._v("type_url")]),e._v(" field. For more information, please refer to "),c("RouterLink",{attrs:{to:"/architecture/adr-019-protobuf-state-encoding.html"}},[e._v("ADR-019")]),e._v(".")],1)])]),e._v(" "),c("li",[c("code",[e._v("Marshaler")]),e._v(": the default codec used throughout the SDK. It is composed of a "),c("code",[e._v("BinaryMarshaler")]),e._v(" used to encode and decode state, and a "),c("code",[e._v("JSONMarshaler")]),e._v(" used to output data to the users (for example in the "),c("a",{attrs:{href:"#cli"}},[e._v("CLI")]),e._v("). By default, the SDK uses Protobuf as "),c("code",[e._v("Marshaler")]),e._v(".")]),e._v(" "),c("li",[c("code",[e._v("TxConfig")]),e._v(": "),c("code",[e._v("TxConfig")]),e._v(" defines an interface a client can utilize to generate an application-defined concrete transaction type. Currently, the SDK handles two transaction types: "),c("code",[e._v("SIGN_MODE_DIRECT")]),e._v(" (which uses Protobuf binary as over-the-wire encoding) and "),c("code",[e._v("SIGN_MODE_LEGACY_AMINO_JSON")]),e._v(" (which depends on Amino). Read more about transactions "),c("RouterLink",{attrs:{to:"/core/transactions.html"}},[e._v("here")]),e._v(".")],1),e._v(" "),c("li",[c("code",[e._v("Amino")]),e._v(": Some legacy parts of the SDK still use Amino for backwards-compatibility. Each module exposes a "),c("code",[e._v("RegisterLegacyAmino")]),e._v(" method to register the module's specific types within Amino. This "),c("code",[e._v("Amino")]),e._v(" codec should not be used by app developers anymore, and will be removed in future releases.")])]),e._v(" "),c("p",[e._v("The SDK exposes a "),c("code",[e._v("MakeTestEncodingConfig")]),e._v(" function used to create a "),c("code",[e._v("EncodingConfig")]),e._v(" for the app constructor ("),c("code",[e._v("NewApp")]),e._v("). It uses Protobuf as a default "),c("code",[e._v("Marshaler")]),e._v(".\nNOTE: this function is marked deprecated and should only be used to create an app or in tests. We are working on refactoring codec management in a post Stargate release.")]),e._v(" "),c("p",[e._v("See an example of a "),c("code",[e._v("MakeTestEncodingConfig")]),e._v(" from "),c("code",[e._v("simapp")]),e._v(":")]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSBjbWQKCmltcG9ydCAoCgkmcXVvdDtjb250ZXh0JnF1b3Q7CgkmcXVvdDtpbyZxdW90OwoJJnF1b3Q7b3MmcXVvdDsKCSZxdW90O3BhdGgvZmlsZXBhdGgmcXVvdDsKCgkmcXVvdDtnaXRodWIuY29tL3NwZjEzL2Nhc3QmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vc3BmMTMvY29icmEmcXVvdDsKCXRtY2xpICZxdW90O2dpdGh1Yi5jb20vdGVuZGVybWludC90ZW5kZXJtaW50L2xpYnMvY2xpJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL3RlbmRlcm1pbnQvdGVuZGVybWludC9saWJzL2xvZyZxdW90OwoJZGJtICZxdW90O2dpdGh1Yi5jb20vdGVuZGVybWludC90bS1kYiZxdW90OwoKCSZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvYmFzZWFwcCZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay9jbGllbnQmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvY2xpZW50L2RlYnVnJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL2NsaWVudC9mbGFncyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay9jbGllbnQva2V5cyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay9jbGllbnQvcnBjJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL2NvZGVjJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3NlcnZlciZxdW90OwoJc2VydmVydHlwZXMgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay9zZXJ2ZXIvdHlwZXMmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvc2ltYXBwJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3NpbWFwcC9wYXJhbXMmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvc25hcHNob3RzJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3N0b3JlJnF1b3Q7CglzZGsgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay90eXBlcyZxdW90OwoJYXV0aGNsaWVudCAmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3gvYXV0aC9jbGllbnQmcXVvdDsKCWF1dGhjbWQgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay94L2F1dGgvY2xpZW50L2NsaSZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay94L2F1dGgvdHlwZXMmcXVvdDsKCXZlc3RpbmdjbGkgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay94L2F1dGgvdmVzdGluZy9jbGllbnQvY2xpJnF1b3Q7CgliYW5rdHlwZXMgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay94L2JhbmsvdHlwZXMmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsveC9jcmlzaXMmcXVvdDsKCWdlbnV0aWxjbGkgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay94L2dlbnV0aWwvY2xpZW50L2NsaSZxdW90OwopCgovLyBOZXdSb290Q21kIGNyZWF0ZXMgYSBuZXcgcm9vdCBjb21tYW5kIGZvciBzaW1kLiBJdCBpcyBjYWxsZWQgb25jZSBpbiB0aGUKLy8gbWFpbiBmdW5jdGlvbi4KZnVuYyBOZXdSb290Q21kKCkgKCpjb2JyYS5Db21tYW5kLCBwYXJhbXMuRW5jb2RpbmdDb25maWcpIHsKCWVuY29kaW5nQ29uZmlnIDo9IHNpbWFwcC5NYWtlVGVzdEVuY29kaW5nQ29uZmlnKCkKCWluaXRDbGllbnRDdHggOj0gY2xpZW50LkNvbnRleHR7fS4KCQlXaXRoSlNPTk1hcnNoYWxlcihlbmNvZGluZ0NvbmZpZy5NYXJzaGFsZXIpLgoJCVdpdGhJbnRlcmZhY2VSZWdpc3RyeShlbmNvZGluZ0NvbmZpZy5JbnRlcmZhY2VSZWdpc3RyeSkuCgkJV2l0aFR4Q29uZmlnKGVuY29kaW5nQ29uZmlnLlR4Q29uZmlnKS4KCQlXaXRoTGVnYWN5QW1pbm8oZW5jb2RpbmdDb25maWcuQW1pbm8pLgoJCVdpdGhJbnB1dChvcy5TdGRpbikuCgkJV2l0aEFjY291bnRSZXRyaWV2ZXIodHlwZXMuQWNjb3VudFJldHJpZXZlcnt9KS4KCQlXaXRoQnJvYWRjYXN0TW9kZShmbGFncy5Ccm9hZGNhc3RCbG9jaykuCgkJV2l0aEhvbWVEaXIoc2ltYXBwLkRlZmF1bHROb2RlSG9tZSkKCglyb290Q21kIDo9ICZhbXA7Y29icmEuQ29tbWFuZHsKCQlVc2U6ICAgJnF1b3Q7c2ltZCZxdW90OywKCQlTaG9ydDogJnF1b3Q7c2ltdWxhdGlvbiBhcHAmcXVvdDssCgkJUGVyc2lzdGVudFByZVJ1bkU6IGZ1bmMoY21kICpjb2JyYS5Db21tYW5kLCBfIFtdc3RyaW5nKSBlcnJvciB7CgkJCWlmIGVyciA6PSBjbGllbnQuU2V0Q21kQ2xpZW50Q29udGV4dEhhbmRsZXIoaW5pdENsaWVudEN0eCwgY21kKTsgZXJyICE9IG5pbCB7CgkJCQlyZXR1cm4gZXJyCgkJCX0KCgkJCXJldHVybiBzZXJ2ZXIuSW50ZXJjZXB0Q29uZmlnc1ByZVJ1bkhhbmRsZXIoY21kKQoJCX0sCgl9CgoJaW5pdFJvb3RDbWQocm9vdENtZCwgZW5jb2RpbmdDb25maWcpCgoJcmV0dXJuIHJvb3RDbWQsIGVuY29kaW5nQ29uZmlnCn0KCi8vIEV4ZWN1dGUgZXhlY3V0ZXMgdGhlIHJvb3QgY29tbWFuZC4KZnVuYyBFeGVjdXRlKHJvb3RDbWQgKmNvYnJhLkNvbW1hbmQpIGVycm9yIHsKCS8vIENyZWF0ZSBhbmQgc2V0IGEgY2xpZW50LkNvbnRleHQgb24gdGhlIGNvbW1hbmQncyBDb250ZXh0LiBEdXJpbmcgdGhlIHByZS1ydW4KCS8vIG9mIHRoZSByb290IGNvbW1hbmQsIGEgZGVmYXVsdCBpbml0aWFsaXplZCBjbGllbnQuQ29udGV4dCBpcyBwcm92aWRlZCB0bwoJLy8gc2VlZCBjaGlsZCBjb21tYW5kIGV4ZWN1dGlvbiB3aXRoIHZhbHVlcyBzdWNoIGFzIEFjY291bnRSZXRyaXZlciwgS2V5cmluZywKCS8vIGFuZCBhIFRlbmRlcm1pbnQgUlBDLiBUaGlzIHJlcXVpcmVzIHRoZSB1c2Ugb2YgYSBwb2ludGVyIHJlZmVyZW5jZSB3aGVuCgkvLyBnZXR0aW5nIGFuZCBzZXR0aW5nIHRoZSBjbGllbnQuQ29udGV4dC4gSWRlYWxseSwgd2UgdXRpbGl6ZQoJLy8gaHR0cHM6Ly9naXRodWIuY29tL3NwZjEzL2NvYnJhL3B1bGwvMTExOC4KCXNydkN0eCA6PSBzZXJ2ZXIuTmV3RGVmYXVsdENvbnRleHQoKQoJY3R4IDo9IGNvbnRleHQuQmFja2dyb3VuZCgpCgljdHggPSBjb250ZXh0LldpdGhWYWx1ZShjdHgsIGNsaWVudC5DbGllbnRDb250ZXh0S2V5LCAmYW1wO2NsaWVudC5Db250ZXh0e30pCgljdHggPSBjb250ZXh0LldpdGhWYWx1ZShjdHgsIHNlcnZlci5TZXJ2ZXJDb250ZXh0S2V5LCBzcnZDdHgpCgoJcm9vdENtZC5QZXJzaXN0ZW50RmxhZ3MoKS5TdHJpbmcoJnF1b3Q7bG9nX2xldmVsJnF1b3Q7LCBzcnZDdHguQ29uZmlnLkxvZ0xldmVsLCAmcXVvdDtUaGUgbG9nZ2luZyBsZXZlbCBpbiB0aGUgZm9ybWF0IG9mICZsdDttb2R1bGUmZ3Q7OiZsdDtsZXZlbCZndDssLi4uJnF1b3Q7KQoKCWV4ZWN1dG9yIDo9IHRtY2xpLlByZXBhcmVCYXNlQ21kKHJvb3RDbWQsICZxdW90OyZxdW90Oywgc2ltYXBwLkRlZmF1bHROb2RlSG9tZSkKCXJldHVybiBleGVjdXRvci5FeGVjdXRlQ29udGV4dChjdHgpCn0KCmZ1bmMgaW5pdFJvb3RDbWQocm9vdENtZCAqY29icmEuQ29tbWFuZCwgZW5jb2RpbmdDb25maWcgcGFyYW1zLkVuY29kaW5nQ29uZmlnKSB7CglhdXRoY2xpZW50LkNvZGVjID0gZW5jb2RpbmdDb25maWcuTWFyc2hhbGVyCgoJcm9vdENtZC5BZGRDb21tYW5kKAoJCWdlbnV0aWxjbGkuSW5pdENtZChzaW1hcHAuTW9kdWxlQmFzaWNzLCBzaW1hcHAuRGVmYXVsdE5vZGVIb21lKSwKCQlnZW51dGlsY2xpLkNvbGxlY3RHZW5UeHNDbWQoYmFua3R5cGVzLkdlbmVzaXNCYWxhbmNlc0l0ZXJhdG9ye30sIHNpbWFwcC5EZWZhdWx0Tm9kZUhvbWUpLAoJCWdlbnV0aWxjbGkuTWlncmF0ZUdlbmVzaXNDbWQoKSwKCQlnZW51dGlsY2xpLkdlblR4Q21kKHNpbWFwcC5Nb2R1bGVCYXNpY3MsIGVuY29kaW5nQ29uZmlnLlR4Q29uZmlnLCBiYW5rdHlwZXMuR2VuZXNpc0JhbGFuY2VzSXRlcmF0b3J7fSwgc2ltYXBwLkRlZmF1bHROb2RlSG9tZSksCgkJZ2VudXRpbGNsaS5WYWxpZGF0ZUdlbmVzaXNDbWQoc2ltYXBwLk1vZHVsZUJhc2ljcywgZW5jb2RpbmdDb25maWcuVHhDb25maWcpLAoJCUFkZEdlbmVzaXNBY2NvdW50Q21kKHNpbWFwcC5EZWZhdWx0Tm9kZUhvbWUpLAoJCXRtY2xpLk5ld0NvbXBsZXRpb25DbWQocm9vdENtZCwgdHJ1ZSksCgkJdGVzdG5ldENtZChzaW1hcHAuTW9kdWxlQmFzaWNzLCBiYW5rdHlwZXMuR2VuZXNpc0JhbGFuY2VzSXRlcmF0b3J7fSksCgkJZGVidWcuQ21kKCksCgkpCgoJc2VydmVyLkFkZENvbW1hbmRzKHJvb3RDbWQsIHNpbWFwcC5EZWZhdWx0Tm9kZUhvbWUsIG5ld0FwcCwgY3JlYXRlU2ltYXBwQW5kRXhwb3J0LCBhZGRNb2R1bGVJbml0RmxhZ3MpCgoJLy8gYWRkIGtleWJhc2UsIGF1eGlsaWFyeSBSUEMsIHF1ZXJ5LCBhbmQgdHggY2hpbGQgY29tbWFuZHMKCXJvb3RDbWQuQWRkQ29tbWFuZCgKCQlycGMuU3RhdHVzQ29tbWFuZCgpLAoJCXF1ZXJ5Q29tbWFuZCgpLAoJCXR4Q29tbWFuZCgpLAoJCWtleXMuQ29tbWFuZHMoc2ltYXBwLkRlZmF1bHROb2RlSG9tZSksCgkpCn0KCmZ1bmMgYWRkTW9kdWxlSW5pdEZsYWdzKHN0YXJ0Q21kICpjb2JyYS5Db21tYW5kKSB7CgljcmlzaXMuQWRkTW9kdWxlSW5pdEZsYWdzKHN0YXJ0Q21kKQp9CgpmdW5jIHF1ZXJ5Q29tbWFuZCgpICpjb2JyYS5Db21tYW5kIHsKCWNtZCA6PSAmYW1wO2NvYnJhLkNvbW1hbmR7CgkJVXNlOiAgICAgICAgICAgICAgICAgICAgICAgICZxdW90O3F1ZXJ5JnF1b3Q7LAoJCUFsaWFzZXM6ICAgICAgICAgICAgICAgICAgICBbXXN0cmluZ3smcXVvdDtxJnF1b3Q7fSwKCQlTaG9ydDogICAgICAgICAgICAgICAgICAgICAgJnF1b3Q7UXVlcnlpbmcgc3ViY29tbWFuZHMmcXVvdDssCgkJRGlzYWJsZUZsYWdQYXJzaW5nOiAgICAgICAgIHRydWUsCgkJU3VnZ2VzdGlvbnNNaW5pbXVtRGlzdGFuY2U6IDIsCgkJUnVuRTogICAgICAgICAgICAgICAgICAgICAgIGNsaWVudC5WYWxpZGF0ZUNtZCwKCX0KCgljbWQuQWRkQ29tbWFuZCgKCQlhdXRoY21kLkdldEFjY291bnRDbWQoKSwKCQlycGMuVmFsaWRhdG9yQ29tbWFuZCgpLAoJCXJwYy5CbG9ja0NvbW1hbmQoKSwKCQlhdXRoY21kLlF1ZXJ5VHhzQnlFdmVudHNDbWQoKSwKCQlhdXRoY21kLlF1ZXJ5VHhDbWQoKSwKCSkKCglzaW1hcHAuTW9kdWxlQmFzaWNzLkFkZFF1ZXJ5Q29tbWFuZHMoY21kKQoJY21kLlBlcnNpc3RlbnRGbGFncygpLlN0cmluZyhmbGFncy5GbGFnQ2hhaW5JRCwgJnF1b3Q7JnF1b3Q7LCAmcXVvdDtUaGUgbmV0d29yayBjaGFpbiBJRCZxdW90OykKCglyZXR1cm4gY21kCn0KCmZ1bmMgdHhDb21tYW5kKCkgKmNvYnJhLkNvbW1hbmQgewoJY21kIDo9ICZhbXA7Y29icmEuQ29tbWFuZHsKCQlVc2U6ICAgICAgICAgICAgICAgICAgICAgICAgJnF1b3Q7dHgmcXVvdDssCgkJU2hvcnQ6ICAgICAgICAgICAgICAgICAgICAgICZxdW90O1RyYW5zYWN0aW9ucyBzdWJjb21tYW5kcyZxdW90OywKCQlEaXNhYmxlRmxhZ1BhcnNpbmc6ICAgICAgICAgdHJ1ZSwKCQlTdWdnZXN0aW9uc01pbmltdW1EaXN0YW5jZTogMiwKCQlSdW5FOiAgICAgICAgICAgICAgICAgICAgICAgY2xpZW50LlZhbGlkYXRlQ21kLAoJfQoKCWNtZC5BZGRDb21tYW5kKAoJCWF1dGhjbWQuR2V0U2lnbkNvbW1hbmQoKSwKCQlhdXRoY21kLkdldFNpZ25CYXRjaENvbW1hbmQoKSwKCQlhdXRoY21kLkdldE11bHRpU2lnbkNvbW1hbmQoKSwKCQlhdXRoY21kLkdldFZhbGlkYXRlU2lnbmF0dXJlc0NvbW1hbmQoKSwKCQlmbGFncy5MaW5lQnJlYWssCgkJYXV0aGNtZC5HZXRCcm9hZGNhc3RDb21tYW5kKCksCgkJYXV0aGNtZC5HZXRFbmNvZGVDb21tYW5kKCksCgkJYXV0aGNtZC5HZXREZWNvZGVDb21tYW5kKCksCgkJZmxhZ3MuTGluZUJyZWFrLAoJCXZlc3RpbmdjbGkuR2V0VHhDbWQoKSwKCSkKCglzaW1hcHAuTW9kdWxlQmFzaWNzLkFkZFR4Q29tbWFuZHMoY21kKQoJY21kLlBlcnNpc3RlbnRGbGFncygpLlN0cmluZyhmbGFncy5GbGFnQ2hhaW5JRCwgJnF1b3Q7JnF1b3Q7LCAmcXVvdDtUaGUgbmV0d29yayBjaGFpbiBJRCZxdW90OykKCglyZXR1cm4gY21kCn0KCmZ1bmMgbmV3QXBwKGxvZ2dlciBsb2cuTG9nZ2VyLCBkYiBkYm0uREIsIHRyYWNlU3RvcmUgaW8uV3JpdGVyLCBhcHBPcHRzIHNlcnZlcnR5cGVzLkFwcE9wdGlvbnMpIHNlcnZlcnR5cGVzLkFwcGxpY2F0aW9uIHsKCXZhciBjYWNoZSBzZGsuTXVsdGlTdG9yZVBlcnNpc3RlbnRDYWNoZQoKCWlmIGNhc3QuVG9Cb29sKGFwcE9wdHMuR2V0KHNlcnZlci5GbGFnSW50ZXJCbG9ja0NhY2hlKSkgewoJCWNhY2hlID0gc3RvcmUuTmV3Q29tbWl0S1ZTdG9yZUNhY2hlTWFuYWdlcigpCgl9CgoJc2tpcFVwZ3JhZGVIZWlnaHRzIDo9IG1ha2UobWFwW2ludDY0XWJvb2wpCglmb3IgXywgaCA6PSByYW5nZSBjYXN0LlRvSW50U2xpY2UoYXBwT3B0cy5HZXQoc2VydmVyLkZsYWdVbnNhZmVTa2lwVXBncmFkZXMpKSB7CgkJc2tpcFVwZ3JhZGVIZWlnaHRzW2ludDY0KGgpXSA9IHRydWUKCX0KCglwcnVuaW5nT3B0cywgZXJyIDo9IHNlcnZlci5HZXRQcnVuaW5nT3B0aW9uc0Zyb21GbGFncyhhcHBPcHRzKQoJaWYgZXJyICE9IG5pbCB7CgkJcGFuaWMoZXJyKQoJfQoKCXNuYXBzaG90RGlyIDo9IGZpbGVwYXRoLkpvaW4oY2FzdC5Ub1N0cmluZyhhcHBPcHRzLkdldChmbGFncy5GbGFnSG9tZSkpLCAmcXVvdDtkYXRhJnF1b3Q7LCAmcXVvdDtzbmFwc2hvdHMmcXVvdDspCglzbmFwc2hvdERCLCBlcnIgOj0gc2RrLk5ld0xldmVsREIoJnF1b3Q7bWV0YWRhdGEmcXVvdDssIHNuYXBzaG90RGlyKQoJaWYgZXJyICE9IG5pbCB7CgkJcGFuaWMoZXJyKQoJfQoJc25hcHNob3RTdG9yZSwgZXJyIDo9IHNuYXBzaG90cy5OZXdTdG9yZShzbmFwc2hvdERCLCBzbmFwc2hvdERpcikKCWlmIGVyciAhPSBuaWwgewoJCXBhbmljKGVycikKCX0KCglyZXR1cm4gc2ltYXBwLk5ld1NpbUFwcCgKCQlsb2dnZXIsIGRiLCB0cmFjZVN0b3JlLCB0cnVlLCBza2lwVXBncmFkZUhlaWdodHMsCgkJY2FzdC5Ub1N0cmluZyhhcHBPcHRzLkdldChmbGFncy5GbGFnSG9tZSkpLAoJCWNhc3QuVG9VaW50KGFwcE9wdHMuR2V0KHNlcnZlci5GbGFnSW52Q2hlY2tQZXJpb2QpKSwKCQlzaW1hcHAuTWFrZVRlc3RFbmNvZGluZ0NvbmZpZygpLCAvLyBJZGVhbGx5LCB3ZSB3b3VsZCByZXVzZSB0aGUgb25lIGNyZWF0ZWQgYnkgTmV3Um9vdENtZC4KCQlhcHBPcHRzLAoJCWJhc2VhcHAuU2V0UHJ1bmluZyhwcnVuaW5nT3B0cyksCgkJYmFzZWFwcC5TZXRNaW5HYXNQcmljZXMoY2FzdC5Ub1N0cmluZyhhcHBPcHRzLkdldChzZXJ2ZXIuRmxhZ01pbkdhc1ByaWNlcykpKSwKCQliYXNlYXBwLlNldEhhbHRIZWlnaHQoY2FzdC5Ub1VpbnQ2NChhcHBPcHRzLkdldChzZXJ2ZXIuRmxhZ0hhbHRIZWlnaHQpKSksCgkJYmFzZWFwcC5TZXRIYWx0VGltZShjYXN0LlRvVWludDY0KGFwcE9wdHMuR2V0KHNlcnZlci5GbGFnSGFsdFRpbWUpKSksCgkJYmFzZWFwcC5TZXRNaW5SZXRhaW5CbG9ja3MoY2FzdC5Ub1VpbnQ2NChhcHBPcHRzLkdldChzZXJ2ZXIuRmxhZ01pblJldGFpbkJsb2NrcykpKSwKCQliYXNlYXBwLlNldEludGVyQmxvY2tDYWNoZShjYWNoZSksCgkJYmFzZWFwcC5TZXRUcmFjZShjYXN0LlRvQm9vbChhcHBPcHRzLkdldChzZXJ2ZXIuRmxhZ1RyYWNlKSkpLAoJCWJhc2VhcHAuU2V0SW5kZXhFdmVudHMoY2FzdC5Ub1N0cmluZ1NsaWNlKGFwcE9wdHMuR2V0KHNlcnZlci5GbGFnSW5kZXhFdmVudHMpKSksCgkJYmFzZWFwcC5TZXRTbmFwc2hvdFN0b3JlKHNuYXBzaG90U3RvcmUpLAoJCWJhc2VhcHAuU2V0U25hcHNob3RJbnRlcnZhbChjYXN0LlRvVWludDY0KGFwcE9wdHMuR2V0KHNlcnZlci5GbGFnU3RhdGVTeW5jU25hcHNob3RJbnRlcnZhbCkpKSwKCQliYXNlYXBwLlNldFNuYXBzaG90S2VlcFJlY2VudChjYXN0LlRvVWludDMyKGFwcE9wdHMuR2V0KHNlcnZlci5GbGFnU3RhdGVTeW5jU25hcHNob3RLZWVwUmVjZW50KSkpLAoJKQp9CgovLyBjcmVhdGVTaW1hcHBBbmRFeHBvcnQgY3JlYXRlcyBhIG5ldyBzaW1hcHAgKG9wdGlvbmFsbHkgYXQgYSBnaXZlbiBoZWlnaHQpCi8vIGFuZCBleHBvcnRzIHN0YXRlLgpmdW5jIGNyZWF0ZVNpbWFwcEFuZEV4cG9ydCgKCWxvZ2dlciBsb2cuTG9nZ2VyLCBkYiBkYm0uREIsIHRyYWNlU3RvcmUgaW8uV3JpdGVyLCBoZWlnaHQgaW50NjQsIGZvclplcm9IZWlnaHQgYm9vbCwgamFpbEFsbG93ZWRBZGRycyBbXXN0cmluZywKCWFwcE9wdHMgc2VydmVydHlwZXMuQXBwT3B0aW9ucykgKHNlcnZlcnR5cGVzLkV4cG9ydGVkQXBwLCBlcnJvcikgewoKCWVuY0NmZyA6PSBzaW1hcHAuTWFrZVRlc3RFbmNvZGluZ0NvbmZpZygpIC8vIElkZWFsbHksIHdlIHdvdWxkIHJldXNlIHRoZSBvbmUgY3JlYXRlZCBieSBOZXdSb290Q21kLgoJZW5jQ2ZnLk1hcnNoYWxlciA9IGNvZGVjLk5ld1Byb3RvQ29kZWMoZW5jQ2ZnLkludGVyZmFjZVJlZ2lzdHJ5KQoJdmFyIHNpbUFwcCAqc2ltYXBwLlNpbUFwcAoJaWYgaGVpZ2h0ICE9IC0xIHsKCQlzaW1BcHAgPSBzaW1hcHAuTmV3U2ltQXBwKGxvZ2dlciwgZGIsIHRyYWNlU3RvcmUsIGZhbHNlLCBtYXBbaW50NjRdYm9vbHt9LCAmcXVvdDsmcXVvdDssIHVpbnQoMSksIGVuY0NmZywgYXBwT3B0cykKCgkJaWYgZXJyIDo9IHNpbUFwcC5Mb2FkSGVpZ2h0KGhlaWdodCk7IGVyciAhPSBuaWwgewoJCQlyZXR1cm4gc2VydmVydHlwZXMuRXhwb3J0ZWRBcHB7fSwgZXJyCgkJfQoJfSBlbHNlIHsKCQlzaW1BcHAgPSBzaW1hcHAuTmV3U2ltQXBwKGxvZ2dlciwgZGIsIHRyYWNlU3RvcmUsIHRydWUsIG1hcFtpbnQ2NF1ib29se30sICZxdW90OyZxdW90OywgdWludCgxKSwgZW5jQ2ZnLCBhcHBPcHRzKQoJfQoKCXJldHVybiBzaW1BcHAuRXhwb3J0QXBwU3RhdGVBbmRWYWxpZGF0b3JzKGZvclplcm9IZWlnaHQsIGphaWxBbGxvd2VkQWRkcnMpCn0K"}})],1),e._v(" "),c("h2",{attrs:{id:"modules"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#modules"}},[e._v("#")]),e._v(" Modules")]),e._v(" "),c("p",[c("RouterLink",{attrs:{to:"/building-modules/intro.html"}},[e._v("Modules")]),e._v(" are the heart and soul of SDK applications. They can be considered as state-machines within the state-machine. When a transaction is relayed from the underlying Tendermint engine via the ABCI to the application, it is routed by "),c("RouterLink",{attrs:{to:"/core/baseapp.html"}},[c("code",[e._v("baseapp")])]),e._v(" to the appropriate module in order to be processed. This paradigm enables developers to easily build complex state-machines, as most of the modules they need often already exist. For developers, most of the work involved in building an SDK application revolves around building custom modules required by their application that do not exist yet, and integrating them with modules that do already exist into one coherent application. In the application directory, the standard practice is to store modules in the "),c("code",[e._v("x/")]),e._v(" folder (not to be confused with the SDK's "),c("code",[e._v("x/")]),e._v(" folder, which contains already-built modules).")],1),e._v(" "),c("h3",{attrs:{id:"application-module-interface"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#application-module-interface"}},[e._v("#")]),e._v(" Application Module Interface")]),e._v(" "),c("p",[e._v("Modules must implement "),c("RouterLink",{attrs:{to:"/building-modules/module-manager.html#application-module-interfaces"}},[e._v("interfaces")]),e._v(" defined in the Cosmos SDK, "),c("RouterLink",{attrs:{to:"/building-modules/module-manager.html#appmodulebasic"}},[c("code",[e._v("AppModuleBasic")])]),e._v(" and "),c("RouterLink",{attrs:{to:"/building-modules/module-manager.html#appmodule"}},[c("code",[e._v("AppModule")])]),e._v(". The former implements basic non-dependant elements of the module, such as the "),c("code",[e._v("codec")]),e._v(", while the latter handles the bulk of the module methods (including methods that require references to other modules' "),c("code",[e._v("keeper")]),e._v("s). Both the "),c("code",[e._v("AppModule")]),e._v(" and "),c("code",[e._v("AppModuleBasic")]),e._v(" types are defined in a file called "),c("code",[e._v("./module.go")]),e._v(".")],1),e._v(" "),c("p",[c("code",[e._v("AppModule")]),e._v(" exposes a collection of useful methods on the module that facilitates the composition of modules into a coherent application. These methods are are called from the "),c("code",[e._v("module manager")]),e._v("(../building-modules/module-manager.md#manager), which manages the application's collection of modules.")]),e._v(" "),c("h3",{attrs:{id:"msg-services"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#msg-services"}},[e._v("#")]),e._v(" "),c("code",[e._v("Msg")]),e._v(" Services")]),e._v(" "),c("p",[e._v("Each module defines two "),c("a",{attrs:{href:"https://developers.google.com/protocol-buffers/docs/proto#services",target:"_blank",rel:"noopener noreferrer"}},[e._v("Protobuf services"),c("OutboundLink")],1),e._v(": one "),c("code",[e._v("Msg")]),e._v(" service to handle messages, and one gRPC "),c("code",[e._v("Query")]),e._v(" service to handle queries. If we consider the module as a state-machine, then a "),c("code",[e._v("Msg")]),e._v(" is a state transition. A "),c("code",[e._v("Msg")]),e._v(" service is a Protobuf service defining all possible "),c("code",[e._v("Msg")]),e._v("s a module exposes. Note that "),c("code",[e._v("Msg")]),e._v("s are bundled in "),c("RouterLink",{attrs:{to:"/core/transactions.html"}},[c("code",[e._v("transactions")])]),e._v(", and each transaction contains one or multiple "),c("code",[e._v("messages")]),e._v(".")],1),e._v(" "),c("p",[e._v("When a valid block of transactions is received by the full-node, Tendermint relays each one to the application via "),c("a",{attrs:{href:"https://tendermint.com/docs/app-dev/abci-spec.html#delivertx",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("DeliverTx")]),c("OutboundLink")],1),e._v(". Then, the application handles the transaction:")]),e._v(" "),c("ol",[c("li",[e._v("Upon receiving the transaction, the application first unmarshalls it from "),c("code",[e._v("[]bytes")]),e._v(".")]),e._v(" "),c("li",[e._v("Then, it verifies a few things about the transaction like "),c("RouterLink",{attrs:{to:"/basics/app-anatomy.html#gas-fees.md#antehandler"}},[e._v("fee payment and signatures")]),e._v(" before extracting the "),c("code",[e._v("Msg")]),e._v("(s) contained in the transaction.")],1),e._v(" "),c("li",[c("code",[e._v("Msg")]),e._v("s are encoded as Protobuf "),c("a",{attrs:{href:"#register-codec"}},[c("code",[e._v("Any")]),e._v("s")]),e._v(" via the "),c("code",[e._v("sdk.ServiceMsg")]),e._v(" struct. By analyzing each "),c("code",[e._v("Any")]),e._v("'s "),c("code",[e._v("type_url")]),e._v(", baseapp's "),c("code",[e._v("msgServiceRouter")]),e._v(" routes the "),c("code",[e._v("Msg")]),e._v(" to the corresponding module's "),c("code",[e._v("Msg")]),e._v(" service.")]),e._v(" "),c("li",[e._v("If the message is successfully processed, the state is updated.")])]),e._v(" "),c("p",[e._v("For a more detailed look at a transaction lifecycle, click "),c("RouterLink",{attrs:{to:"/basics/tx-lifecycle.html"}},[e._v("here")]),e._v(".")],1),e._v(" "),c("p",[e._v("Module developers create custom "),c("code",[e._v("Msg")]),e._v("s when they build their own module. The general practice is to define all "),c("code",[e._v("Msg")]),e._v("s in a Protobuf service called "),c("code",[e._v("service Msg {}")]),e._v(", and define each "),c("code",[e._v("Msg")]),e._v(" as a Protobuf service method, using the "),c("code",[e._v("rpc")]),e._v(" keyword. These definitions usually reside in a "),c("code",[e._v("tx.proto")]),e._v(" file. For example, the "),c("code",[e._v("x/bank")]),e._v(" module defines two "),c("code",[e._v("Msg")]),e._v("s to allows users to transfer tokens:")]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"false",base64:"Ly8gTXNnIGRlZmluZXMgdGhlIGJhbmsgTXNnIHNlcnZpY2UuCnNlcnZpY2UgTXNnIHsKICAvLyBTZW5kIGRlZmluZXMgYSBtZXRob2QgZm9yIHNlbmRpbmcgY29pbnMgZnJvbSBvbmUgYWNjb3VudCB0byBhbm90aGVyIGFjY291bnQuCiAgcnBjIFNlbmQoTXNnU2VuZCkgcmV0dXJucyAoTXNnU2VuZFJlc3BvbnNlKTsKCiAgLy8gTXVsdGlTZW5kIGRlZmluZXMgYSBtZXRob2QgZm9yIHNlbmRpbmcgY29pbnMgZnJvbSBzb21lIGFjY291bnRzIHRvIG90aGVyIGFjY291bnRzLgogIHJwYyBNdWx0aVNlbmQoTXNnTXVsdGlTZW5kKSByZXR1cm5zIChNc2dNdWx0aVNlbmRSZXNwb25zZSk7Cn0="}})],1),e._v(" "),c("p",[e._v("These two "),c("code",[e._v("Msg")]),e._v("s are processed by the "),c("code",[e._v("Msg")]),e._v(" service of the "),c("code",[e._v("x/bank")]),e._v(" module, which ultimately calls the "),c("code",[e._v("keeper")]),e._v(" of the "),c("code",[e._v("x/auth")]),e._v(" module in order to update the state.")]),e._v(" "),c("p",[e._v("Each module should also implement the "),c("code",[e._v("RegisterServices")]),e._v(" method as part of the "),c("a",{attrs:{href:"#application-module-interface"}},[c("code",[e._v("AppModule")]),e._v(" interface")]),e._v(". This method should call the "),c("code",[e._v("RegisterMsgServer")]),e._v(" function provided by the generated Protobuf code.")]),e._v(" "),c("h3",{attrs:{id:"grpc-query-services"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#grpc-query-services"}},[e._v("#")]),e._v(" gRPC "),c("code",[e._v("Query")]),e._v(" Services")]),e._v(" "),c("p",[e._v("gRPC "),c("code",[e._v("Query")]),e._v(" services are introduced in the v0.40 Stargate release. They allow users to query the state using "),c("a",{attrs:{href:"https://grpc.io",target:"_blank",rel:"noopener noreferrer"}},[e._v("gRPC"),c("OutboundLink")],1),e._v(". They are enabled by default, and can be configued under the "),c("code",[e._v("grpc.enable")]),e._v(" and "),c("code",[e._v("grpc.address")]),e._v(" fields inside "),c("RouterLink",{attrs:{to:"/run-node/run-node.html#configuring-the-node-using-apptoml"}},[c("code",[e._v("app.toml")])]),e._v(".")],1),e._v(" "),c("p",[e._v("gRPC "),c("code",[e._v("Query")]),e._v(" services are defined in the module's Protobuf definition files, specifically inside "),c("code",[e._v("query.proto")]),e._v(". The "),c("code",[e._v("query.proto")]),e._v(" definition file exposes a single "),c("code",[e._v("Query")]),e._v(" "),c("a",{attrs:{href:"https://developers.google.com/protocol-buffers/docs/proto#services",target:"_blank",rel:"noopener noreferrer"}},[e._v("Protobuf service"),c("OutboundLink")],1),e._v(". Each gRPC query endpoint corresponds to a service method, starting with the "),c("code",[e._v("rpc")]),e._v(" keyword, inside the "),c("code",[e._v("Query")]),e._v(" service.")]),e._v(" "),c("p",[e._v("Protobuf generates a "),c("code",[e._v("QueryServer")]),e._v(" interface for each module, containing all the service methods. A module's "),c("a",{attrs:{href:"#keeper"}},[c("code",[e._v("keeper")])]),e._v(" then needs to implement this "),c("code",[e._v("QueryServer")]),e._v(" interface, by providing the concrete implementation of each service method. This concrete implementation is the handler of the corresponding gRPC query endpoint.")]),e._v(" "),c("p",[e._v("Finally, each module should also implement the "),c("code",[e._v("RegisterServices")]),e._v(" method as part of the "),c("a",{attrs:{href:"#application-module-interface"}},[c("code",[e._v("AppModule")]),e._v(" interface")]),e._v(". This method should call the "),c("code",[e._v("RegisterQueryServer")]),e._v(" function provided by the generated Protobuf code.")]),e._v(" "),c("h3",{attrs:{id:"keeper"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#keeper"}},[e._v("#")]),e._v(" Keeper")]),e._v(" "),c("p",[c("RouterLink",{attrs:{to:"/building-modules/keeper.html"}},[c("code",[e._v("Keepers")])]),e._v(" are the gatekeepers of their module's store(s). To read or write in a module's store, it is mandatory to go through one of its "),c("code",[e._v("keeper")]),e._v("'s methods. This is ensured by the "),c("RouterLink",{attrs:{to:"/core/ocap.html"}},[e._v("object-capabilities")]),e._v(" model of the Cosmos SDK. Only objects that hold the key to a store can access it, and only the module's "),c("code",[e._v("keeper")]),e._v(" should hold the key(s) to the module's store(s).")],1),e._v(" "),c("p",[c("code",[e._v("Keepers")]),e._v(" are generally defined in a file called "),c("code",[e._v("keeper.go")]),e._v(". It contains the "),c("code",[e._v("keeper")]),e._v("'s type definition and methods.")]),e._v(" "),c("p",[e._v("The "),c("code",[e._v("keeper")]),e._v(" type definition generally consists of:")]),e._v(" "),c("ul",[c("li",[c("strong",[e._v("Key(s)")]),e._v(" to the module's store(s) in the multistore.")]),e._v(" "),c("li",[e._v("Reference to "),c("strong",[e._v("other module's "),c("code",[e._v("keepers")])]),e._v(". Only needed if the "),c("code",[e._v("keeper")]),e._v(" needs to access other module's store(s) (either to read or write from them).")]),e._v(" "),c("li",[e._v("A reference to the application's "),c("strong",[e._v("codec")]),e._v(". The "),c("code",[e._v("keeper")]),e._v(" needs it to marshal structs before storing them, or to unmarshal them when it retrieves them, because stores only accept "),c("code",[e._v("[]bytes")]),e._v(" as value.")])]),e._v(" "),c("p",[e._v("Along with the type definition, the next important component of the "),c("code",[e._v("keeper.go")]),e._v(" file is the "),c("code",[e._v("keeper")]),e._v("'s constructor function, "),c("code",[e._v("NewKeeper")]),e._v(". This function instantiates a new "),c("code",[e._v("keeper")]),e._v(" of the type defined above, with a "),c("code",[e._v("codec")]),e._v(", store "),c("code",[e._v("keys")]),e._v(" and potentially references to other modules' "),c("code",[e._v("keeper")]),e._v("s as parameters. The "),c("code",[e._v("NewKeeper")]),e._v(" function is called from the "),c("a",{attrs:{href:"#constructor-function"}},[e._v("application's constructor")]),e._v(". The rest of the file defines the "),c("code",[e._v("keeper")]),e._v("'s methods, primarily getters and setters.")]),e._v(" "),c("h3",{attrs:{id:"command-line-grpc-services-and-rest-interfaces"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#command-line-grpc-services-and-rest-interfaces"}},[e._v("#")]),e._v(" Command-Line, gRPC Services and REST Interfaces")]),e._v(" "),c("p",[e._v("Each module defines command-line commands, gRPC services and REST routes to be exposed to end-user via the "),c("a",{attrs:{href:"#application-interfaces"}},[e._v("application's interfaces")]),e._v(". This enables end-users to create messages of the types defined in the module, or to query the subset of the state managed by the module.")]),e._v(" "),c("h4",{attrs:{id:"cli"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#cli"}},[e._v("#")]),e._v(" CLI")]),e._v(" "),c("p",[e._v("Generally, the "),c("RouterLink",{attrs:{to:"/building-modules/module-interfaces.html#cli"}},[e._v("commands related to a module")]),e._v(" are defined in a folder called "),c("code",[e._v("client/cli")]),e._v(" in the module's folder. The CLI divides commands in two category, transactions and queries, defined in "),c("code",[e._v("client/cli/tx.go")]),e._v(" and "),c("code",[e._v("client/cli/query.go")]),e._v(" respectively. Both commands are built on top of the "),c("a",{attrs:{href:"https://github.com/spf13/cobra",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cobra Library"),c("OutboundLink")],1),e._v(":")],1),e._v(" "),c("ul",[c("li",[e._v("Transactions commands let users generate new transactions so that they can be included in a block and eventually update the state. One command should be created for each "),c("a",{attrs:{href:"#message-types"}},[e._v("message type")]),e._v(" defined in the module. The command calls the constructor of the message with the parameters provided by the end-user, and wraps it into a transaction. The SDK handles signing and the addition of other transaction metadata.")]),e._v(" "),c("li",[e._v("Queries let users query the subset of the state defined by the module. Query commands forward queries to the "),c("RouterLink",{attrs:{to:"/core/baseapp.html#query-routing"}},[e._v("application's query router")]),e._v(", which routes them to the appropriate "),c("a",{attrs:{href:"#querier"}},[e._v("querier")]),e._v(" the "),c("code",[e._v("queryRoute")]),e._v(" parameter supplied.")],1)]),e._v(" "),c("h4",{attrs:{id:"grpc"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#grpc"}},[e._v("#")]),e._v(" gRPC")]),e._v(" "),c("p",[c("a",{attrs:{href:"https://grpc.io",target:"_blank",rel:"noopener noreferrer"}},[e._v("gRPC"),c("OutboundLink")],1),e._v(" is a modern open source high performance RPC framework that has support in multiple languages. It is the recommended way for external clients (such as wallets, browsers and other backend services) to interact with a node.")]),e._v(" "),c("p",[e._v("Each module can expose gRPC endpoints, called "),c("a",{attrs:{href:"https://grpc.io/docs/what-is-grpc/core-concepts/#service-definition",target:"_blank",rel:"noopener noreferrer"}},[e._v("service methods"),c("OutboundLink")],1),e._v(" and are defined in the "),c("a",{attrs:{href:"#grpc-query-services"}},[e._v("module's Protobuf "),c("code",[e._v("query.proto")]),e._v(" file")]),e._v(". A service method is defined by its name, input arguments and output response. The module then needs to:")]),e._v(" "),c("ul",[c("li",[e._v("define a "),c("code",[e._v("RegisterGRPCGatewayRoutes")]),e._v(" method on "),c("code",[e._v("AppModuleBasic")]),e._v(" to wire the client gRPC requests to the correct handler inside the module.")]),e._v(" "),c("li",[e._v("for each service method, define a corresponding handler. The handler implements the core logic necessary to serve the gRPC request, and is located in the "),c("code",[e._v("keeper/grpc_query.go")]),e._v(" file.")])]),e._v(" "),c("h4",{attrs:{id:"grpc-gateway-rest-endpoints"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#grpc-gateway-rest-endpoints"}},[e._v("#")]),e._v(" gRPC-gateway REST Endpoints")]),e._v(" "),c("p",[e._v("Some external clients may not wish to use gRPC. The SDK provides in this case a gRPC gateway service, which exposes each gRPC service as a correspoding REST endpoint. Please refer to the "),c("a",{attrs:{href:"https://grpc-ecosystem.github.io/grpc-gateway/",target:"_blank",rel:"noopener noreferrer"}},[e._v("grpc-gateway"),c("OutboundLink")],1),e._v(" documentation to learn more.")]),e._v(" "),c("p",[e._v("The REST endpoints are defined in the Protobuf files, along with the gRPC services, using Protobuf annotations. Modules that want to expose REST queries should add "),c("code",[e._v("google.api.http")]),e._v(" annotations to their "),c("code",[e._v("rpc")]),e._v(" methods. By default, all REST endpoints defined in the SDK have an URL starting with the "),c("code",[e._v("/cosmos/")]),e._v(" prefix.")]),e._v(" "),c("p",[e._v("The SDK also provides a development endpoint to generate "),c("a",{attrs:{href:"https://swagger.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Swagger"),c("OutboundLink")],1),e._v(" definition files for these REST endpoints. This endpoint can be enabled inside the "),c("RouterLink",{attrs:{to:"/run-node/run-node.html#configuring-the-node-using-apptoml"}},[c("code",[e._v("app.toml")])]),e._v(" config file, under the "),c("code",[e._v("api.swagger")]),e._v(" key.")],1),e._v(" "),c("h4",{attrs:{id:"legacy-api-rest-endpoints"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#legacy-api-rest-endpoints"}},[e._v("#")]),e._v(" Legacy API REST Endpoints")]),e._v(" "),c("p",[e._v("The "),c("RouterLink",{attrs:{to:"/building-modules/module-interfaces.html#legacy-rest"}},[e._v("module's Legacy REST interface")]),e._v(" lets users generate transactions and query the state through REST calls to the application's Legacy API Service. REST routes are defined in a file "),c("code",[e._v("client/rest/rest.go")]),e._v(", which is composed of:")],1),e._v(" "),c("ul",[c("li",[e._v("A "),c("code",[e._v("RegisterRoutes")]),e._v(" function, which registers each route defined in the file. This function is called from the "),c("a",{attrs:{href:"#application-interfaces"}},[e._v("main application's interface")]),e._v(" for each module used within the application. The router used in the SDK is "),c("a",{attrs:{href:"https://github.com/gorilla/mux",target:"_blank",rel:"noopener noreferrer"}},[e._v("Gorilla's mux"),c("OutboundLink")],1),e._v(".")]),e._v(" "),c("li",[e._v("Custom request type definitions for each query or transaction creation function that needs to be exposed. These custom request types build on the base "),c("code",[e._v("request")]),e._v(" type of the Cosmos SDK:\n"),c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gQmFzZVJlcSBkZWZpbmVzIGEgc3RydWN0dXJlIHRoYXQgY2FuIGJlIGVtYmVkZGVkIGluIG90aGVyIHJlcXVlc3Qgc3RydWN0dXJlcwovLyB0aGF0IGFsbCBzaGFyZSBjb21tb24gJnF1b3Q7YmFzZSZxdW90OyBmaWVsZHMuCnR5cGUgQmFzZVJlcSBzdHJ1Y3QgewoJRnJvbSAgICAgICAgICBzdHJpbmcgICAgICAgYGpzb246JnF1b3Q7ZnJvbSZxdW90O2AKCU1lbW8gICAgICAgICAgc3RyaW5nICAgICAgIGBqc29uOiZxdW90O21lbW8mcXVvdDtgCglDaGFpbklEICAgICAgIHN0cmluZyAgICAgICBganNvbjomcXVvdDtjaGFpbl9pZCZxdW90O2AKCUFjY291bnROdW1iZXIgdWludDY0ICAgICAgIGBqc29uOiZxdW90O2FjY291bnRfbnVtYmVyJnF1b3Q7YAoJU2VxdWVuY2UgICAgICB1aW50NjQgICAgICAgYGpzb246JnF1b3Q7c2VxdWVuY2UmcXVvdDtgCglUaW1lb3V0SGVpZ2h0IHVpbnQ2NCAgICAgICBganNvbjomcXVvdDt0aW1lb3V0X2hlaWdodCZxdW90O2AKCUZlZXMgICAgICAgICAgc2RrLkNvaW5zICAgIGBqc29uOiZxdW90O2ZlZXMmcXVvdDtgCglHYXNQcmljZXMgICAgIHNkay5EZWNDb2lucyBganNvbjomcXVvdDtnYXNfcHJpY2VzJnF1b3Q7YAoJR2FzICAgICAgICAgICBzdHJpbmcgICAgICAgYGpzb246JnF1b3Q7Z2FzJnF1b3Q7YAoJR2FzQWRqdXN0bWVudCBzdHJpbmcgICAgICAgYGpzb246JnF1b3Q7Z2FzX2FkanVzdG1lbnQmcXVvdDtgCglTaW11bGF0ZSAgICAgIGJvb2wgICAgICAgICBganNvbjomcXVvdDtzaW11bGF0ZSZxdW90O2AKfQ=="}})],1),e._v(" "),c("li",[e._v("One handler function for each request that can be routed to the given module. These functions implement the core logic necessary to serve the request.")])]),e._v(" "),c("p",[e._v("These Legacy API endpoints are present in the SDK for backward compatibility purposes and will be removed in the next release.")]),e._v(" "),c("h2",{attrs:{id:"application-interface"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#application-interface"}},[e._v("#")]),e._v(" Application Interface")]),e._v(" "),c("p",[c("RouterLink",{attrs:{to:"/interfaces/interfaces-intro.html"}},[e._v("Interfaces")]),e._v(" let end-users interact with full-node clients. This means querying data from the full-node or creating and sending new transactions to be relayed by the full-node and eventually included in a block.")],1),e._v(" "),c("p",[e._v("The main interface is the "),c("RouterLink",{attrs:{to:"/interfaces/cli.html"}},[e._v("Command-Line Interface")]),e._v(". The CLI of an SDK application is built by aggregating "),c("a",{attrs:{href:"#cli"}},[e._v("CLI commands")]),e._v(" defined in each of the modules used by the application. The CLI of an application is the same as the daemon (e.g. "),c("code",[e._v("appd")]),e._v("), and defined in a file called "),c("code",[e._v("appd/main.go")]),e._v(". The file contains:")],1),e._v(" "),c("ul",[c("li",[c("strong",[e._v("A "),c("code",[e._v("main()")]),e._v(" function")]),e._v(", which is executed to build the "),c("code",[e._v("appd")]),e._v(" interface client. This function prepares each command and adds them to the "),c("code",[e._v("rootCmd")]),e._v(" before building them. At the root of "),c("code",[e._v("appd")]),e._v(", the function adds generic commands like "),c("code",[e._v("status")]),e._v(", "),c("code",[e._v("keys")]),e._v(" and "),c("code",[e._v("config")]),e._v(", query commands, tx commands and "),c("code",[e._v("rest-server")]),e._v(".")]),e._v(" "),c("li",[c("strong",[e._v("Query commands")]),e._v(" are added by calling the "),c("code",[e._v("queryCmd")]),e._v(" function. This function returns a Cobra command that contains the query commands defined in each of the application's modules (passed as an array of "),c("code",[e._v("sdk.ModuleClients")]),e._v(" from the "),c("code",[e._v("main()")]),e._v(" function), as well as some other lower level query commands such as block or validator queries. Query command are called by using the command "),c("code",[e._v("appd query [query]")]),e._v(" of the CLI.")]),e._v(" "),c("li",[c("strong",[e._v("Transaction commands")]),e._v(" are added by calling the "),c("code",[e._v("txCmd")]),e._v(" function. Similar to "),c("code",[e._v("queryCmd")]),e._v(", the function returns a Cobra command that contains the tx commands defined in each of the application's modules, as well as lower level tx commands like transaction signing or broadcasting. Tx commands are called by using the command "),c("code",[e._v("appd tx [tx]")]),e._v(" of the CLI.")])]),e._v(" "),c("p",[e._v("See an example of an application's main command-line file from the "),c("a",{attrs:{href:"https://github.com/cosmos/sdk-tutorials/tree/master/nameservice",target:"_blank",rel:"noopener noreferrer"}},[e._v("nameservice tutorial"),c("OutboundLink")],1)]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSBtYWluCgppbXBvcnQgKAoJJnF1b3Q7b3MmcXVvdDsKCSZxdW90O3BhdGgmcXVvdDsKCgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL2NsaWVudCZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay9jbGllbnQva2V5cyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay9jbGllbnQvbGNkJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL2NsaWVudC9ycGMmcXVvdDsKCXNkayAmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3R5cGVzJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3ZlcnNpb24mcXVvdDsKCWF1dGhjbWQgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay94L2F1dGgvY2xpZW50L2NsaSZxdW90OwoJYXV0aHJlc3QgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay94L2F1dGgvY2xpZW50L3Jlc3QmcXVvdDsKCWJhbmtjbWQgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay94L2JhbmsvY2xpZW50L2NsaSZxdW90OwoJYXBwICZxdW90O2dpdGh1Yi5jb20vY29zbW9zL3Nkay10dXRvcmlhbHMvbmFtZXNlcnZpY2UmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vc3BmMTMvY29icmEmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vc3BmMTMvdmlwZXImcXVvdDsKCWFtaW5vICZxdW90O2dpdGh1Yi5jb20vdGVuZGVybWludC9nby1hbWlubyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS90ZW5kZXJtaW50L3RlbmRlcm1pbnQvbGlicy9jbGkmcXVvdDsKKQoKZnVuYyBtYWluKCkgewoJY29icmEuRW5hYmxlQ29tbWFuZFNvcnRpbmcgPSBmYWxzZQoKCWNkYyA6PSBhcHAuTWFrZUNvZGVjKCkKCgkvLyBSZWFkIGluIHRoZSBjb25maWd1cmF0aW9uIGZpbGUgZm9yIHRoZSBzZGsKCWNvbmZpZyA6PSBzZGsuR2V0Q29uZmlnKCkKCWNvbmZpZy5TZXRCZWNoMzJQcmVmaXhGb3JBY2NvdW50KHNkay5CZWNoMzJQcmVmaXhBY2NBZGRyLCBzZGsuQmVjaDMyUHJlZml4QWNjUHViKQoJY29uZmlnLlNldEJlY2gzMlByZWZpeEZvclZhbGlkYXRvcihzZGsuQmVjaDMyUHJlZml4VmFsQWRkciwgc2RrLkJlY2gzMlByZWZpeFZhbFB1YikKCWNvbmZpZy5TZXRCZWNoMzJQcmVmaXhGb3JDb25zZW5zdXNOb2RlKHNkay5CZWNoMzJQcmVmaXhDb25zQWRkciwgc2RrLkJlY2gzMlByZWZpeENvbnNQdWIpCgljb25maWcuU2VhbCgpCgoJcm9vdENtZCA6PSAmYW1wO2NvYnJhLkNvbW1hbmR7CgkJVXNlOiAgICZxdW90O25zY2xpJnF1b3Q7LAoJCVNob3J0OiAmcXVvdDtuYW1lc2VydmljZSBDbGllbnQmcXVvdDssCgl9CgoJLy8gQWRkIC0tY2hhaW4taWQgdG8gcGVyc2lzdGVudCBmbGFncyBhbmQgbWFyayBpdCByZXF1aXJlZAoJcm9vdENtZC5QZXJzaXN0ZW50RmxhZ3MoKS5TdHJpbmcoY2xpZW50LkZsYWdDaGFpbklELCAmcXVvdDsmcXVvdDssICZxdW90O0NoYWluIElEIG9mIHRlbmRlcm1pbnQgbm9kZSZxdW90OykKCXJvb3RDbWQuUGVyc2lzdGVudFByZVJ1bkUgPSBmdW5jKF8gKmNvYnJhLkNvbW1hbmQsIF8gW11zdHJpbmcpIGVycm9yIHsKCQlyZXR1cm4gaW5pdENvbmZpZyhyb290Q21kKQoJfQoKCS8vIENvbnN0cnVjdCBSb290IENvbW1hbmQKCXJvb3RDbWQuQWRkQ29tbWFuZCgKCQlycGMuU3RhdHVzQ29tbWFuZCgpLAoJCWNsaWVudC5Db25maWdDbWQoYXBwLkRlZmF1bHRDTElIb21lKSwKCQlxdWVyeUNtZChjZGMpLAoJCXR4Q21kKGNkYyksCgkJY2xpZW50LkxpbmVCcmVhaywKCQlsY2QuU2VydmVDb21tYW5kKGNkYywgcmVnaXN0ZXJSb3V0ZXMpLAoJCWNsaWVudC5MaW5lQnJlYWssCgkJa2V5cy5Db21tYW5kcygpLAoJCWNsaWVudC5MaW5lQnJlYWssCgkJdmVyc2lvbi5DbWQsCgkJY2xpZW50Lk5ld0NvbXBsZXRpb25DbWQocm9vdENtZCwgdHJ1ZSksCgkpCgoJZXhlY3V0b3IgOj0gY2xpLlByZXBhcmVNYWluQ21kKHJvb3RDbWQsICZxdW90O05TJnF1b3Q7LCBhcHAuRGVmYXVsdENMSUhvbWUpCgllcnIgOj0gZXhlY3V0b3IuRXhlY3V0ZSgpCglpZiBlcnIgIT0gbmlsIHsKCQlwYW5pYyhlcnIpCgl9Cn0KCmZ1bmMgcmVnaXN0ZXJSb3V0ZXMocnMgKmxjZC5SZXN0U2VydmVyKSB7CgljbGllbnQuUmVnaXN0ZXJSb3V0ZXMocnMuQ2xpQ3R4LCBycy5NdXgpCglhdXRocmVzdC5SZWdpc3RlclR4Um91dGVzKHJzLkNsaUN0eCwgcnMuTXV4KQoJYXBwLk1vZHVsZUJhc2ljcy5SZWdpc3RlclJFU1RSb3V0ZXMocnMuQ2xpQ3R4LCBycy5NdXgpCn0KCmZ1bmMgcXVlcnlDbWQoY2RjICphbWluby5Db2RlYykgKmNvYnJhLkNvbW1hbmQgewoJcXVlcnlDbWQgOj0gJmFtcDtjb2JyYS5Db21tYW5kewoJCVVzZTogICAgICZxdW90O3F1ZXJ5JnF1b3Q7LAoJCUFsaWFzZXM6IFtdc3RyaW5neyZxdW90O3EmcXVvdDt9LAoJCVNob3J0OiAgICZxdW90O1F1ZXJ5aW5nIHN1YmNvbW1hbmRzJnF1b3Q7LAoJfQoKCXF1ZXJ5Q21kLkFkZENvbW1hbmQoCgkJYXV0aGNtZC5HZXRBY2NvdW50Q21kKGNkYyksCgkJY2xpZW50LkxpbmVCcmVhaywKCQlycGMuVmFsaWRhdG9yQ29tbWFuZChjZGMpLAoJCXJwYy5CbG9ja0NvbW1hbmQoKSwKCQlhdXRoY21kLlF1ZXJ5VHhzQnlFdmVudHNDbWQoY2RjKSwKCQlhdXRoY21kLlF1ZXJ5VHhDbWQoY2RjKSwKCQljbGllbnQuTGluZUJyZWFrLAoJKQoKCS8vIGFkZCBtb2R1bGVzJyBxdWVyeSBjb21tYW5kcwoJYXBwLk1vZHVsZUJhc2ljcy5BZGRRdWVyeUNvbW1hbmRzKHF1ZXJ5Q21kLCBjZGMpCgoJcmV0dXJuIHF1ZXJ5Q21kCn0KCmZ1bmMgdHhDbWQoY2RjICphbWluby5Db2RlYykgKmNvYnJhLkNvbW1hbmQgewoJdHhDbWQgOj0gJmFtcDtjb2JyYS5Db21tYW5kewoJCVVzZTogICAmcXVvdDt0eCZxdW90OywKCQlTaG9ydDogJnF1b3Q7VHJhbnNhY3Rpb25zIHN1YmNvbW1hbmRzJnF1b3Q7LAoJfQoKCXR4Q21kLkFkZENvbW1hbmQoCgkJYmFua2NtZC5TZW5kVHhDbWQoY2RjKSwKCQljbGllbnQuTGluZUJyZWFrLAoJCWF1dGhjbWQuR2V0U2lnbkNvbW1hbmQoY2RjKSwKCQlhdXRoY21kLkdldE11bHRpU2lnbkNvbW1hbmQoY2RjKSwKCQljbGllbnQuTGluZUJyZWFrLAoJCWF1dGhjbWQuR2V0QnJvYWRjYXN0Q29tbWFuZChjZGMpLAoJCWF1dGhjbWQuR2V0RW5jb2RlQ29tbWFuZChjZGMpLAoJCWNsaWVudC5MaW5lQnJlYWssCgkpCgoJLy8gYWRkIG1vZHVsZXMnIHR4IGNvbW1hbmRzCglhcHAuTW9kdWxlQmFzaWNzLkFkZFR4Q29tbWFuZHModHhDbWQsIGNkYykKCglyZXR1cm4gdHhDbWQKfQoKZnVuYyBpbml0Q29uZmlnKGNtZCAqY29icmEuQ29tbWFuZCkgZXJyb3IgewoJaG9tZSwgZXJyIDo9IGNtZC5QZXJzaXN0ZW50RmxhZ3MoKS5HZXRTdHJpbmcoY2xpLkhvbWVGbGFnKQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIGVycgoJfQoKCWNmZ0ZpbGUgOj0gcGF0aC5Kb2luKGhvbWUsICZxdW90O2NvbmZpZyZxdW90OywgJnF1b3Q7Y29uZmlnLnRvbWwmcXVvdDspCglpZiBfLCBlcnIgOj0gb3MuU3RhdChjZmdGaWxlKTsgZXJyID09IG5pbCB7CgkJdmlwZXIuU2V0Q29uZmlnRmlsZShjZmdGaWxlKQoKCQlpZiBlcnIgOj0gdmlwZXIuUmVhZEluQ29uZmlnKCk7IGVyciAhPSBuaWwgewoJCQlyZXR1cm4gZXJyCgkJfQoJfQoJaWYgZXJyIDo9IHZpcGVyLkJpbmRQRmxhZyhjbGllbnQuRmxhZ0NoYWluSUQsIGNtZC5QZXJzaXN0ZW50RmxhZ3MoKS5Mb29rdXAoY2xpZW50LkZsYWdDaGFpbklEKSk7IGVyciAhPSBuaWwgewoJCXJldHVybiBlcnIKCX0KCWlmIGVyciA6PSB2aXBlci5CaW5kUEZsYWcoY2xpLkVuY29kaW5nRmxhZywgY21kLlBlcnNpc3RlbnRGbGFncygpLkxvb2t1cChjbGkuRW5jb2RpbmdGbGFnKSk7IGVyciAhPSBuaWwgewoJCXJldHVybiBlcnIKCX0KCXJldHVybiB2aXBlci5CaW5kUEZsYWcoY2xpLk91dHB1dEZsYWcsIGNtZC5QZXJzaXN0ZW50RmxhZ3MoKS5Mb29rdXAoY2xpLk91dHB1dEZsYWcpKQp9Cg=="}})],1),e._v(" "),c("h2",{attrs:{id:"dependencies-and-makefile"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#dependencies-and-makefile"}},[e._v("#")]),e._v(" Dependencies and Makefile")]),e._v(" "),c("p",[e._v("This section is optional, as developers are free to choose their dependency manager and project building method. That said, the current most used framework for versioning control is "),c("a",{attrs:{href:"https://github.com/golang/go/wiki/Modules",target:"_blank",rel:"noopener noreferrer"}},[c("code",[e._v("go.mod")]),c("OutboundLink")],1),e._v(". It ensures each of the libraries used throughout the application are imported with the correct version. See an example from the "),c("a",{attrs:{href:"https://github.com/cosmos/sdk-tutorials/tree/master/nameservice",target:"_blank",rel:"noopener noreferrer"}},[e._v("nameservice tutorial"),c("OutboundLink")],1),e._v(":")]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"false",base64:"bW9kdWxlIGdpdGh1Yi5jb20vY29zbW9zL3Nkay1hcHBsaWNhdGlvbi10dXRvcmlhbAoKZ28gMS4xMwoKcmVxdWlyZSAoCglnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrIHYwLjM3LjMKCWdpdGh1Yi5jb20vZ29yaWxsYS9tdXggdjEuNy4zCglnaXRodWIuY29tL21hdHRuL2dvLWlzYXR0eSB2MC4wLjcgLy8gaW5kaXJlY3QKCWdpdGh1Yi5jb20vc3BmMTMvYWZlcm8gdjEuMi4yIC8vIGluZGlyZWN0CglnaXRodWIuY29tL3NwZjEzL2NvYnJhIHYwLjAuNQoJZ2l0aHViLmNvbS9zcGYxMy92aXBlciB2MS40LjAKCWdpdGh1Yi5jb20vc3RyZXRjaHIvdGVzdGlmeSB2MS40LjAKCWdpdGh1Yi5jb20vdGVuZGVybWludC9nby1hbWlubyB2MC4xNS4xCglnaXRodWIuY29tL3RlbmRlcm1pbnQvdGVuZGVybWludCB2MC4zMi42CglnaXRodWIuY29tL3RlbmRlcm1pbnQvdG0tZGIgdjAuMi4wCglnb2xhbmcub3JnL3gvc3lzIHYwLjAuMC0yMDE5MDMyOTA0NDczMy05ZWIxYmZhMWNlNjUgLy8gaW5kaXJlY3QKCWdvb2dsZS5nb2xhbmcub3JnL2dlbnByb3RvIHYwLjAuMC0yMDE5MDMyNzEyNTY0My1kODMxZDY1ZmUxN2QgLy8gaW5kaXJlY3QKKQ=="}})],1),e._v(" "),c("p",[e._v("For building the application, a "),c("a",{attrs:{href:"https://en.wikipedia.org/wiki/Makefile",target:"_blank",rel:"noopener noreferrer"}},[e._v("Makefile"),c("OutboundLink")],1),e._v(" is generally used. The Makefile primarily ensures that the "),c("code",[e._v("go.mod")]),e._v(" is run before building the two entrypoints to the application, "),c("a",{attrs:{href:"#node-client"}},[c("code",[e._v("appd")])]),e._v(" and "),c("a",{attrs:{href:"#application-interface"}},[c("code",[e._v("appd")])]),e._v(". See an example of Makefile from the "),c("a",{attrs:{href:""}},[e._v("nameservice tutorial")])]),e._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"false",base64:"UEFDS0FHRVM9JChzaGVsbCBnbyBsaXN0IC4vLi4uIHwgZ3JlcCAtdiAnL3NpbXVsYXRpb24nKQoKVkVSU0lPTiA6PSAkKHNoZWxsIGVjaG8gJChzaGVsbCBnaXQgZGVzY3JpYmUgLS10YWdzKSB8IHNlZCAncy9edi8vJykKQ09NTUlUIDo9ICQoc2hlbGwgZ2l0IGxvZyAtMSAtLWZvcm1hdD0nJUgnKQoKbGRmbGFncyA9IC1YIGdpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvdmVyc2lvbi5OYW1lPU5hbWVTZXJ2aWNlIFwKCS1YIGdpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvdmVyc2lvbi5TZXJ2ZXJOYW1lPW5zZCBcCgktWCBnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3ZlcnNpb24uQ2xpZW50TmFtZT1uc2NsaSBcCgktWCBnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3ZlcnNpb24uVmVyc2lvbj0kKFZFUlNJT04pIFwKCS1YIGdpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvdmVyc2lvbi5Db21taXQ9JChDT01NSVQpIAoKQlVJTERfRkxBR1MgOj0gLWxkZmxhZ3MgJyQobGRmbGFncyknCgppbmNsdWRlIE1ha2VmaWxlLmxlZGdlcgphbGw6IGluc3RhbGwKCmluc3RhbGw6IGdvLnN1bQoJCWdvIGluc3RhbGwgLW1vZD1yZWFkb25seSAkKEJVSUxEX0ZMQUdTKSAuL2NtZC9uc2QKCQlnbyBpbnN0YWxsIC1tb2Q9cmVhZG9ubHkgJChCVUlMRF9GTEFHUykgLi9jbWQvbnNjbGkKCmdvLnN1bTogZ28ubW9kCgkJQGVjaG8gJnF1b3Q7LS0mZ3Q7IEVuc3VyZSBkZXBlbmRlbmNpZXMgaGF2ZSBub3QgYmVlbiBtb2RpZmllZCZxdW90OwoJCUdPMTExTU9EVUxFPW9uIGdvIG1vZCB2ZXJpZnkKCnRlc3Q6CglAZ28gdGVzdCAtbW9kPXJlYWRvbmx5ICQoUEFDS0FHRVMp"}})],1),e._v(" "),c("h2",{attrs:{hide:"",id:"next"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#next"}},[e._v("#")]),e._v(" Next")]),e._v(" "),c("p",{attrs:{hide:""}},[e._v("Learn more about the "),c("RouterLink",{attrs:{to:"/basics/tx-lifecycle.html"}},[e._v("Lifecycle of a transaction")])],1)],1)}),[],!1,null,null,null);t.default=o.exports}}]);